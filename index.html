<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“¦ ç‰©æµè¿½è¹¤ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container { max-width: 500px; margin: 0 auto; }
    
    .card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .card-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: #666; }
    .info-value { font-weight: 600; color: #333; }
    
    .items-list {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 8px 12px;
      margin: 8px 0;
    }
    
    .item-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
    }
    
    /* é€²åº¦æ¢ */
    .progress-step {
      display: flex;
      align-items: center;
      padding: 10px;
      margin: 6px 0;
      border-radius: 8px;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .progress-step:hover:not(.disabled) { background: #e9ecef; }
    .progress-step.completed { background: #d4edda; cursor: not-allowed; }
    .progress-step.selected { background: #fff3cd; border: 2px solid #ffc107; }
    .progress-step.disabled { background: #e9ecef; cursor: not-allowed; opacity: 0.6; }
    
    .step-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      margin-right: 10px;
    }
    .step-icon.completed { background: #28a745; color: white; }
    .step-icon.current { background: #ffc107; color: white; }
    .step-icon.pending { background: #e9ecef; color: #999; }
    
    .step-info { flex: 1; }
    .step-title { font-weight: bold; font-size: 14px; }
    .step-detail { font-size: 12px; color: #666; }
    
    /* è¼¸å…¥æ¡† */
    .input-group { margin: 12px 0; }
    .input-label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px; }
    .input-field {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 16px;
    }
    .input-field:focus { outline: none; border-color: #667eea; }
    .input-hint { font-size: 12px; color: #666; margin-top: 4px; }
    
    /* æŒ‰éˆ• */
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    .btn-secondary { background: #f8f9fa; color: #333; margin-top: 10px; }
    
    /* æˆåŠŸé é¢ - ç·Šæ¹Šç‰ˆ */
    .completed-badge { text-align: center; padding: 10px; }
    .completed-icon { font-size: 36px; margin-bottom: 6px; }
    .completed-title { font-size: 18px; font-weight: bold; color: #28a745; }
    
    /* QR Code - ç¸®å°ç‰ˆ */
    .qr-container { text-align: center; padding: 8px; }
    .qr-container p { font-size: 12px; margin-bottom: 6px; color: #666; }
    .qr-image {
      width: 150px;
      height: 150px;
      margin: 6px auto;
      border: 3px solid #667eea;
      border-radius: 10px;
    }
    
    /* æ–°å¢å“é … */
    .item-entry { background: #f8f9fa; border-radius: 8px; padding: 10px; margin: 8px 0; }
    .item-entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .remove-item { background: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; }
    .add-item-btn {
      width: 100%;
      padding: 10px;
      border: 2px dashed #667eea;
      border-radius: 8px;
      background: transparent;
      color: #667eea;
      font-size: 14px;
      cursor: pointer;
      margin: 10px 0;
    }
    
    /* Loading */
    .loading { text-align: center; padding: 40px; }
    .spinner {
      width: 40px; height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* é é¢åˆ‡æ› */
    .page { display: none; }
    .page.active { display: block; }
    
    /* é¸å–® */
    .menu-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
    .menu-btn { padding: 16px; border: none; border-radius: 12px; background: #f8f9fa; cursor: pointer; }
    .menu-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .menu-btn-icon { font-size: 28px; margin-bottom: 6px; }
    .menu-btn-text { font-size: 13px; font-weight: 600; }
    
    /* åˆ—å°æ¨£å¼ */
    @media print {
      @page { size: A4; margin: 10mm; }
      body { background: white !important; padding: 0 !important; min-height: auto !important; }
      .no-print { display: none !important; }
      .container { max-width: 100% !important; }
      .card { box-shadow: none !important; border: 1px solid #ddd; margin-bottom: 0 !important; padding: 12px !important; page-break-inside: avoid; }
      .page { display: none !important; }
      .page.active { display: block !important; }
      .completed-badge { padding: 6px !important; }
      .completed-icon { font-size: 28px !important; }
      .completed-title { font-size: 16px !important; }
      .qr-image { width: 130px !important; height: 130px !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- è¼‰å…¥ä¸­ -->
    <div id="page-loading" class="page active">
      <div class="card">
        <div class="loading">
          <div class="spinner"></div>
          <p>è¼‰å…¥ä¸­...</p>
        </div>
      </div>
    </div>
    
    <!-- ä¸»é¸å–® -->
    <div id="page-menu" class="page">
      <div class="card">
        <div class="card-title">ğŸ“¦ ç‰©æµè¿½è¹¤ç³»çµ±1.0.4</div>
        <p id="welcome-message">æ­¡è¿ä½¿ç”¨ï¼</p>
        <div class="menu-buttons">
          <button class="menu-btn" onclick="showPage('create')">
            <div class="menu-btn-icon">ğŸ“</div>
            <div class="menu-btn-text">å»ºç«‹åŒ…è£¹</div>
          </button>
          <button class="menu-btn" onclick="startScan()">
            <div class="menu-btn-icon">ğŸ“·</div>
            <div class="menu-btn-text">æƒç¢¼ç°½æ”¶</div>
          </button>
          <button class="menu-btn" onclick="showPage('query')">
            <div class="menu-btn-icon">ğŸ”</div>
            <div class="menu-btn-text">æŸ¥è©¢åŒ…è£¹</div>
          </button>
          <button class="menu-btn" onclick="showPage('history')">
            <div class="menu-btn-icon">ğŸ“‹</div>
            <div class="menu-btn-text">ç°½æ”¶ç´€éŒ„</div>
          </button>
        </div>
      </div>
    </div>
    
    <!-- å»ºç«‹åŒ…è£¹ -->
    <div id="page-create" class="page">
      <div class="card">
        <div class="card-title">ğŸ“ å»ºç«‹æ–°åŒ…è£¹</div>
        
        <div class="input-group">
          <label class="input-label">åˆä½œå¤¥ä¼´ï¼ˆå» å®¶ï¼‰</label>
          <input type="text" id="input-partner" class="input-field" placeholder="ä¾‹å¦‚ï¼šè¶…è±">
        </div>
        
        <div class="input-group">
          <label class="input-label">æ”¶ä»¶è€…</label>
          <input type="text" id="input-receiver" class="input-field" placeholder="æ”¶ä»¶äººå§“å">
        </div>
        
        <div class="input-group">
          <label class="input-label">å“é …æ˜ç´°</label>
          <div id="items-container">
            <div class="item-entry" data-index="0">
              <div style="display: grid; grid-template-columns: 1fr 70px; gap: 6px;">
                <input type="text" class="input-field item-model" placeholder="ç”¢å“å‹è™Ÿ">
                <input type="number" class="input-field item-quantity" placeholder="æ•¸é‡" min="1" value="1">
              </div>
              <input type="text" class="input-field item-accessory" placeholder="é…ä»¶ï¼ˆé¸å¡«ï¼‰" style="margin-top: 6px;">
            </div>
          </div>
          <button class="add-item-btn" onclick="addItem()">+ æ–°å¢å“é …</button>
        </div>
        
        <button class="btn btn-primary" onclick="createPackage()">ç¢ºèªå»ºç«‹</button>
        <button class="btn btn-secondary" onclick="showPage('menu')">è¿”å›</button>
      </div>
    </div>
    
    <!-- å»ºç«‹æˆåŠŸ + QR Code -->
    <div id="page-created" class="page">
      <div class="card" id="print-area">
        <div class="completed-badge">
          <div class="completed-icon">âœ…</div>
          <div class="completed-title">åŒ…è£¹å»ºç«‹æˆåŠŸï¼</div>
        </div>
        
        <div class="info-row">
          <span class="info-label">å–®è™Ÿ</span>
          <span class="info-value" id="created-order-id">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">å» å®¶</span>
          <span class="info-value" id="created-partner">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">æ”¶ä»¶è€…</span>
          <span class="info-value" id="created-receiver">-</span>
        </div>
        
        <div class="items-list" id="created-items"></div>
        
        <div class="qr-container">
          <p>è«‹å°‡æ­¤ QR Code è²¼åœ¨åŒ…è£¹ä¸Š</p>
          <img id="created-qr-image" class="qr-image" src="" alt="QR Code">
        </div>
      </div>
      
      <!-- æŒ‰éˆ•å€ï¼ˆåˆ—å°æ™‚éš±è—ï¼‰ -->
      <div class="card no-print">
        <div class="input-group">
          <label class="input-label">å¯„é€ Email</label>
          <div style="display: flex; gap: 6px;">
            <input type="text" id="input-email-prefix" class="input-field" placeholder="å¸³è™Ÿ" style="flex: 1;">
            <span style="line-height: 44px; font-size: 14px;">@gmt.com.tw</span>
          </div>
        </div>
        
        <button class="btn btn-primary" onclick="sendEmail()">ğŸ“§ å¯„é€ Email</button>
        <button class="btn btn-secondary" onclick="printPage()" style="background: #17a2b8; color: white;">ğŸ–¨ï¸ åˆ—å°æ­¤é </button>
        <button class="btn btn-secondary" onclick="showPage('menu')">å®Œæˆ</button>
      </div>
    </div>
    
    <!-- æŸ¥è©¢åŒ…è£¹ -->
    <div id="page-query" class="page">
      <div class="card">
        <div class="card-title">ğŸ” æŸ¥è©¢åŒ…è£¹</div>
        <div class="input-group">
          <label class="input-label">è¼¸å…¥å–®è™Ÿ</label>
          <input type="text" id="input-query-order" class="input-field" placeholder="ä¾‹å¦‚ï¼š20251128-143022">
        </div>
        <button class="btn btn-primary" onclick="queryPackage()">æŸ¥è©¢</button>
        <button class="btn btn-secondary" onclick="showPage('menu')">è¿”å›</button>
      </div>
    </div>
    
    <!-- ç°½æ”¶é é¢ -->
    <div id="page-sign" class="page">
      <div class="card">
        <div class="card-title">ğŸ“¦ åŒ…è£¹ç°½æ”¶</div>
        
        <div class="info-row">
          <span class="info-label">å–®è™Ÿ</span>
          <span class="info-value" id="sign-order-id">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">å» å®¶</span>
          <span class="info-value" id="sign-partner">-</span>
        </div>
        
        <div class="items-list" id="sign-items"></div>
        
        <div class="card-title" style="margin-top: 12px;">ğŸ“ ç°½æ”¶é€²åº¦ï¼ˆé»æ“Šé¸æ“‡ï¼‰</div>
        <div id="sign-progress"></div>
        
        <div class="input-group" id="name-input-group" style="display: none;">
          <label class="input-label">æ‚¨çš„å§“å</label>
          <input type="text" id="input-signer-name" class="input-field" placeholder="è«‹è¼¸å…¥å§“å">
          <div class="input-hint" id="name-hint"></div>
        </div>
        
        <button class="btn btn-primary" id="btn-confirm-sign" onclick="confirmSign()">ç¢ºèªç°½æ”¶</button>
        <button class="btn btn-secondary" onclick="showPage('menu')">è¿”å›</button>
      </div>
    </div>
    
    <!-- ç°½æ”¶æˆåŠŸ -->
    <div id="page-sign-complete" class="page">
      <div class="card">
        <div class="completed-badge">
          <div class="completed-icon">âœ…</div>
          <div class="completed-title" id="sign-complete-title">ç°½æ”¶æˆåŠŸï¼</div>
        </div>
        <div id="sign-complete-details"></div>
        <button class="btn btn-primary" onclick="showPage('menu')">è¿”å›é¦–é </button>
      </div>
    </div>
    
    <!-- å·²å®Œæˆ -->
    <div id="page-completed" class="page">
      <div class="card">
        <div class="completed-badge">
          <div class="completed-icon">ğŸ‰</div>
          <div class="completed-title">ç‰©æµå·²å®Œæˆï¼</div>
        </div>
        <div id="completed-details"></div>
        <button class="btn btn-primary" onclick="showPage('menu')">è¿”å›é¦–é </button>
      </div>
    </div>
    
    <!-- æ­·å²ç´€éŒ„ -->
    <div id="page-history" class="page">
      <div class="card">
        <div class="card-title">ğŸ“‹ ç°½æ”¶ç´€éŒ„</div>
        <p style="text-align: center; color: #666; padding: 20px;">åŠŸèƒ½é–‹ç™¼ä¸­...</p>
        <button class="btn btn-secondary" onclick="showPage('menu')">è¿”å›</button>
      </div>
    </div>
    
  </div>

  <script>
    // ============ è¨­å®š ============
    const CONFIG = {
      LIFF_ID: '2008586810-kB2lZW95',
      GAS_URL: 'https://script.google.com/macros/s/AKfycbx1x9qVkj1ZEgkmL5F69wJ_-yWHWwPugy6pxGLPKKARKpMgJzmthX6O113SEFnjy7x5/exec'
    };

    const SETTINGS = {
      REQUIRE_NAME: false  // æ˜¯å¦éœ€è¦è¼¸å…¥ç°½æ”¶è€…å§“å
    };

    // å…¨åŸŸè®Šæ•¸
    let currentUser = { lineUserId: '', name: '', preferredRole: '' };
    let currentPackage = null;
    let currentSignStatus = null;
    let selectedRole = null;
    let itemIndex = 1;

    // ============ LIFF åˆå§‹åŒ– ============
    async function initializeLiff() {
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        // æª¢æŸ¥ URL åƒæ•¸
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('orderId');
        
        if (liff.isLoggedIn()) {
          try {
            const profile = await liff.getProfile();
            currentUser.lineUserId = profile.userId;
            currentUser.name = profile.displayName;
          } catch (e) {
            console.log('ç„¡æ³•å–å¾— LINE è³‡è¨Š');
            currentUser.lineUserId = 'anonymous_' + Date.now();
            currentUser.name = 'è¨ªå®¢';
          }
        } else {
          currentUser.lineUserId = 'anonymous_' + Date.now();
          currentUser.name = 'è¨ªå®¢';
        }
        
        if (orderId) {
          await loadPackageForSign(orderId);
        } else {
          showPage('menu');
        }
        
      } catch (error) {
        console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
        currentUser.lineUserId = 'test_' + Date.now();
        currentUser.name = 'æ¸¬è©¦ç”¨æˆ¶';
        showPage('menu');
      }
    }

    // ============ é é¢æ§åˆ¶ ============
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + pageId).classList.add('active');
      
      if (pageId === 'menu') {
        const welcomeEl = document.getElementById('welcome-message');
        welcomeEl.textContent = currentUser.name ? `æ­¡è¿ï¼Œ${currentUser.name}ï¼` : 'æ­¡è¿ä½¿ç”¨ï¼';
      }
      
      if (pageId === 'sign') {
        const nameGroup = document.getElementById('name-input-group');
        nameGroup.style.display = SETTINGS.REQUIRE_NAME ? 'block' : 'none';
      }
    }

    // ============ API å‘¼å«ï¼ˆJSONPï¼‰============
    function apiGet(action, params = {}) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        const url = new URL(CONFIG.GAS_URL);
        url.searchParams.set('action', action);
        url.searchParams.set('callback', callbackName);
        
        Object.keys(params).forEach(key => {
          const value = params[key];
          if (typeof value === 'object') {
            url.searchParams.set(key, JSON.stringify(value));
          } else {
            url.searchParams.set(key, value);
          }
        });
        
        console.log('API Request:', url.toString());
        
        const timeout = setTimeout(() => {
          cleanup();
          reject(new Error('è«‹æ±‚è¶…æ™‚'));
        }, 30000);
        
        let script;
        
        const cleanup = () => {
          clearTimeout(timeout);
          delete window[callbackName];
          if (script && script.parentNode) {
            script.parentNode.removeChild(script);
          }
        };
        
        window[callbackName] = (data) => {
          console.log('API Response:', data);
          cleanup();
          resolve(data);
        };
        
        script = document.createElement('script');
        script.src = url.toString();
        script.onerror = () => {
          cleanup();
          reject(new Error('ç¶²è·¯è«‹æ±‚å¤±æ•—'));
        };
        
        document.head.appendChild(script);
      });
    }

    function apiPost(action, data) {
      const params = {};
      Object.keys(data).forEach(key => {
        const value = data[key];
        params[key] = typeof value === 'object' ? JSON.stringify(value) : value;
      });
      return apiGet(action, params);
    }

    // ============ å»ºç«‹åŒ…è£¹ ============
    function addItem() {
      const container = document.getElementById('items-container');
      const newItem = document.createElement('div');
      newItem.className = 'item-entry';
      newItem.dataset.index = itemIndex;
      newItem.innerHTML = `
        <div class="item-entry-header">
          <span>å“é … ${itemIndex + 1}</span>
          <button class="remove-item" onclick="removeItem(${itemIndex})">Ã—</button>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 70px; gap: 6px;">
          <input type="text" class="input-field item-model" placeholder="ç”¢å“å‹è™Ÿ">
          <input type="number" class="input-field item-quantity" placeholder="æ•¸é‡" min="1" value="1">
        </div>
        <input type="text" class="input-field item-accessory" placeholder="é…ä»¶ï¼ˆé¸å¡«ï¼‰" style="margin-top: 6px;">
      `;
      container.appendChild(newItem);
      itemIndex++;
    }

    function removeItem(index) {
      const item = document.querySelector(`.item-entry[data-index="${index}"]`);
      if (item) item.remove();
    }

    async function createPackage() {
      const partner = document.getElementById('input-partner').value.trim();
      const receiver = document.getElementById('input-receiver').value.trim();
      
      if (!partner || !receiver) {
        alert('è«‹å¡«å¯«å» å®¶å’Œæ”¶ä»¶è€…');
        return;
      }
      
      const items = [];
      document.querySelectorAll('.item-entry').forEach(entry => {
        const model = entry.querySelector('.item-model').value.trim();
        const quantity = parseInt(entry.querySelector('.item-quantity').value) || 1;
        const accessory = entry.querySelector('.item-accessory').value.trim();
        if (model) items.push({ model, quantity, accessory });
      });
      
      if (items.length === 0) {
        alert('è«‹è‡³å°‘å¡«å¯«ä¸€å€‹å“é …');
        return;
      }
      
      showPage('loading');
      
      try {
        const result = await apiPost('createPackage', {
          partner, receiver, items,
          lineUserId: currentUser.lineUserId,
          lineName: currentUser.name
        });
        
        if (result.success) {
          currentPackage = { orderId: result.orderId, partner, receiver, items, qrCodeUrl: result.qrCodeUrl };
          
          document.getElementById('created-order-id').textContent = result.orderId;
          document.getElementById('created-partner').textContent = partner;
          document.getElementById('created-receiver').textContent = receiver;
          
          const itemsHtml = items.map(item => `
            <div class="item-row">
              <span>${item.model}${item.accessory ? ' (' + item.accessory + ')' : ''}</span>
              <span>Ã— ${item.quantity}</span>
            </div>
          `).join('');
          document.getElementById('created-items').innerHTML = itemsHtml;
          document.getElementById('created-qr-image').src = result.qrCodeUrl;
          
          showPage('created');
          
          // æ¸…ç©ºè¡¨å–®
          document.getElementById('input-partner').value = '';
          document.getElementById('input-receiver').value = '';
          document.getElementById('items-container').innerHTML = `
            <div class="item-entry" data-index="0">
              <div style="display: grid; grid-template-columns: 1fr 70px; gap: 6px;">
                <input type="text" class="input-field item-model" placeholder="ç”¢å“å‹è™Ÿ">
                <input type="number" class="input-field item-quantity" placeholder="æ•¸é‡" min="1" value="1">
              </div>
              <input type="text" class="input-field item-accessory" placeholder="é…ä»¶ï¼ˆé¸å¡«ï¼‰" style="margin-top: 6px;">
            </div>
          `;
          itemIndex = 1;
        } else {
          alert('å»ºç«‹å¤±æ•—ï¼š' + result.error);
          showPage('create');
        }
      } catch (error) {
        alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
        showPage('create');
      }
    }

    // ============ Email ============
    async function sendEmail() {
      const prefix = document.getElementById('input-email-prefix').value.trim();
      if (!prefix) {
        alert('è«‹è¼¸å…¥ Email å¸³è™Ÿ');
        return;
      }
      
      const toEmail = prefix + '@gmt.com.tw';
      
      try {
        const result = await apiPost('sendPackageEmail', {
          toEmail,
          orderId: currentPackage.orderId,
          partner: currentPackage.partner,
          receiver: currentPackage.receiver,
          items: currentPackage.items,
          qrCodeUrl: currentPackage.qrCodeUrl
        });
        
        alert(result.success ? 'Email å·²å¯„å‡ºï¼' : 'å¯„é€å¤±æ•—ï¼š' + result.error);
      } catch (error) {
        alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
      }
    }

    function printPage() {
      window.print();
    }

    // ============ æƒç¢¼ ============
    async function startScan() {
      try {
        if (liff.scanCodeV2) {
          const result = await liff.scanCodeV2();
          if (result.value) {
            const url = new URL(result.value);
            const orderId = url.searchParams.get('orderId');
            if (orderId) {
              await loadPackageForSign(orderId);
            } else {
              alert('ç„¡æ•ˆçš„ QR Code');
            }
          }
        } else {
          const orderId = prompt('è«‹è¼¸å…¥å–®è™Ÿï¼ˆæ¸¬è©¦ç”¨ï¼‰ï¼š');
          if (orderId) await loadPackageForSign(orderId);
        }
      } catch (error) {
        console.error('æƒç¢¼å¤±æ•—:', error);
        const orderId = prompt('æƒç¢¼å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥å–®è™Ÿï¼š');
        if (orderId) await loadPackageForSign(orderId);
      }
    }

    // ============ æŸ¥è©¢ ============
    async function queryPackage() {
      const orderId = document.getElementById('input-query-order').value.trim();
      if (!orderId) {
        alert('è«‹è¼¸å…¥å–®è™Ÿ');
        return;
      }
      await loadPackageForSign(orderId);
    }

    // ============ ç°½æ”¶æµç¨‹ ============
    async function loadPackageForSign(orderId) {
      showPage('loading');
      
      try {
        const packageInfo = await apiGet('getPackageInfo', { orderId });
        if (packageInfo.error) {
          alert(packageInfo.error);
          showPage('menu');
          return;
        }
        
        const signStatus = await apiGet('getSignStatus', { orderId });
        if (signStatus.error) {
          alert(signStatus.error);
          showPage('menu');
          return;
        }
        
        currentPackage = packageInfo;
        currentSignStatus = signStatus;
        
        if (signStatus.nextRole === 'completed') {
          showCompletedPage();
          return;
        }
        
        renderSignPage();
      } catch (error) {
        alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        showPage('menu');
      }
    }

    function renderSignPage() {
      document.getElementById('sign-order-id').textContent = currentPackage.orderId;
      document.getElementById('sign-partner').textContent = currentPackage.partner;
      
      const itemsHtml = currentPackage.items.map(item => `
        <div class="item-row">
          <span>${item.model}${item.accessory ? ' (' + item.accessory + ')' : ''}</span>
          <span>Ã— ${item.quantity}</span>
        </div>
      `).join('');
      document.getElementById('sign-items').innerHTML = itemsHtml;
      
      selectedRole = currentSignStatus.nextRole;
      document.getElementById('sign-progress').innerHTML = renderProgress();
      
      if (SETTINGS.REQUIRE_NAME) {
        document.getElementById('input-signer-name').value = currentUser.name || '';
      }
      
      showPage('sign');
    }

    function renderProgress() {
      const steps = [
        { key: 'driver', icon: 'ğŸšš', name: 'å¸æ©Ÿ', data: currentSignStatus.driver },
        { key: 'warehouse', icon: 'ğŸ­', name: 'åº«æˆ¿', data: currentSignStatus.warehouse },
        { key: 'engineer', icon: 'ğŸ‘·', name: 'å·¥ç¨‹å¸«', data: currentSignStatus.engineer }
      ];
      
      return steps.map(step => {
        const isCompleted = step.data.name !== '';
        const isAvailable = currentSignStatus.availableRoles.includes(step.key);
        const isSelected = selectedRole === step.key;
        
        let statusClass = '', detail = 'ç­‰å¾…ä¸­', clickHandler = '';
        
        if (isCompleted) {
          statusClass = 'completed disabled';
          detail = `${step.data.name} (${formatTime(step.data.time)})`;
        } else if (isSelected) {
          statusClass = 'selected';
          detail = 'â† é»æ“Šç°½æ”¶';
          clickHandler = `onclick="selectRole('${step.key}')"`;
        } else if (isAvailable) {
          statusClass = 'pending';
          detail = 'é»æ“Šé¸æ“‡';
          clickHandler = `onclick="selectRole('${step.key}')"`;
        } else {
          statusClass = 'disabled';
        }
        
        return `
          <div class="progress-step ${statusClass}" ${clickHandler}>
            <div class="step-icon ${isCompleted ? 'completed' : (isSelected ? 'current' : 'pending')}">${isCompleted ? 'âœ“' : step.icon}</div>
            <div class="step-info">
              <div class="step-title">${step.name}</div>
              <div class="step-detail">${detail}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function selectRole(role) {
      selectedRole = role;
      document.getElementById('sign-progress').innerHTML = renderProgress();
    }

    async function confirmSign() {
      const roleNames = { driver: 'å¸æ©Ÿ', warehouse: 'åº«æˆ¿', engineer: 'å·¥ç¨‹å¸«' };
      let name = SETTINGS.REQUIRE_NAME 
        ? document.getElementById('input-signer-name').value.trim() 
        : roleNames[selectedRole];
      
      if (SETTINGS.REQUIRE_NAME && !name) {
        alert('è«‹è¼¸å…¥æ‚¨çš„å§“å');
        return;
      }
      
      if (!selectedRole) {
        alert('è«‹é¸æ“‡æ‚¨çš„èº«ä»½');
        return;
      }
      
      document.getElementById('btn-confirm-sign').disabled = true;
      
      try {
        const result = await apiPost('signPackage', {
          orderId: currentPackage.orderId,
          role: selectedRole,
          name: name,
          lineUserId: currentUser.lineUserId
        });
        
        if (result.success) {
          document.getElementById('sign-complete-title').textContent = `${roleNames[selectedRole]}ç°½æ”¶æˆåŠŸï¼`;
          
          let detailsHtml = `<div class="info-row"><span class="info-label">å–®è™Ÿ</span><span class="info-value">${currentPackage.orderId}</span></div>`;
          
          const nextRole = result.status.nextRole;
          if (nextRole === 'completed') {
            detailsHtml += `<div style="text-align: center; margin-top: 20px; color: #28a745;"><div style="font-size: 32px;">ğŸ‰</div><div>ç‰©æµè¿½è¹¤å·²å®Œæˆï¼</div></div>`;
          } else {
            detailsHtml += `<div style="text-align: center; margin-top: 20px; color: #667eea;"><div>ğŸ“ ä¸‹ä¸€ç«™ï¼š${roleNames[nextRole]}</div></div>`;
          }
          
          document.getElementById('sign-complete-details').innerHTML = detailsHtml;
          showPage('sign-complete');
        } else {
          alert('ç°½æ”¶å¤±æ•—ï¼š' + result.error);
        }
      } catch (error) {
        alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
      }
      
      document.getElementById('btn-confirm-sign').disabled = false;
    }

    function showCompletedPage() {
      let detailsHtml = `
        <div class="info-row"><span class="info-label">å–®è™Ÿ</span><span class="info-value">${currentPackage.orderId}</span></div>
        <div class="info-row"><span class="info-label">å» å®¶</span><span class="info-value">${currentPackage.partner}</span></div>
        <hr style="margin: 12px 0; border: none; border-top: 1px solid #eee;">
        <div class="card-title">ğŸ“ ç°½æ”¶æ­·ç¨‹</div>
      `;
      
      const roles = [
        { key: 'driver', icon: 'ğŸšš', name: 'å¸æ©Ÿ', data: currentSignStatus.driver },
        { key: 'warehouse', icon: 'ğŸ­', name: 'åº«æˆ¿', data: currentSignStatus.warehouse },
        { key: 'engineer', icon: 'ğŸ‘·', name: 'å·¥ç¨‹å¸«', data: currentSignStatus.engineer }
      ];
      
      roles.forEach(r => {
        detailsHtml += `
          <div class="progress-step completed">
            <div class="step-icon completed">âœ“</div>
            <div class="step-info">
              <div class="step-title">${r.icon} ${r.name}</div>
              <div class="step-detail">${r.data.name} (${formatTime(r.data.time)})</div>
            </div>
          </div>
        `;
      });
      
      document.getElementById('completed-details').innerHTML = detailsHtml;
      showPage('completed');
    }

    function formatTime(dateStr) {
      if (!dateStr) return '-';
      try {
        const date = new Date(dateStr);
        return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
      } catch (e) {
        return '-';
      }
    }

    // ============ å•Ÿå‹• ============
    document.addEventListener('DOMContentLoaded', initializeLiff);
  </script>
</body>
</html>
