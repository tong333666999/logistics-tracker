<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“¦ ç‰©æµè¿½è¹¤ç³»çµ±</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“¦</text></svg>">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container { max-width: 500px; margin: 0 auto; }
    
    .card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .card-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: #666; }
    .info-value { font-weight: 600; color: #333; }
    
    .items-list {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 8px 12px;
      margin: 8px 0;
    }
    
    .item-row {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
    }
    
    /* é€²åº¦æ¢ */
    .progress-step {
      display: flex;
      align-items: center;
      padding: 10px;
      margin: 6px 0;
      border-radius: 8px;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .progress-step:hover:not(.disabled) { background: #e9ecef; }
    .progress-step.completed { background: #d4edda; cursor: not-allowed; }
    .progress-step.selected { background: #fff3cd; border: 2px solid #ffc107; }
    .progress-step.disabled { background: #e9ecef; cursor: not-allowed; opacity: 0.6; }
    
    .step-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      margin-right: 10px;
    }
    .step-icon.completed { background: #28a745; color: white; }
    .step-icon.current { background: #ffc107; color: white; }
    .step-icon.pending { background: #e9ecef; color: #999; }
    
    .step-info { flex: 1; }
    .step-title { font-weight: bold; font-size: 14px; }
    .step-detail { font-size: 12px; color: #666; }
    
    /* è¼¸å…¥æ¡† */
    .input-group { margin: 12px 0; }
    .input-label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px; }
    .input-field {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 16px;
    }
    .input-field:focus { outline: none; border-color: #667eea; }
    .input-hint { font-size: 12px; color: #666; margin-top: 4px; }
    
    /* æŒ‰éˆ• */
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
    .btn-secondary { background: #f8f9fa; color: #333; margin-top: 10px; }
    
    /* æˆåŠŸé é¢ - ç·Šæ¹Šç‰ˆ */
    .completed-badge { text-align: center; padding: 10px; }
    .completed-icon { font-size: 36px; margin-bottom: 6px; }
    .completed-title { font-size: 18px; font-weight: bold; color: #28a745; }
    
    /* QR Code - ç¸®å°ç‰ˆ */
    .qr-container { text-align: center; padding: 8px; }
    .qr-container p { font-size: 12px; margin-bottom: 6px; color: #666; }
    .qr-image {
      width: 150px;
      height: 150px;
      margin: 6px auto;
      border: 3px solid #667eea;
      border-radius: 10px;
    }
    
    /* æ–°å¢å“é … */
    .item-entry { background: #f8f9fa; border-radius: 8px; padding: 10px; margin: 8px 0; }
    .item-entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
    .remove-item { background: #dc3545; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; }
    .add-item-btn {
      width: 100%;
      padding: 10px;
      border: 2px dashed #667eea;
      border-radius: 8px;
      background: transparent;
      color: #667eea;
      font-size: 14px;
      cursor: pointer;
      margin: 10px 0;
    }
    
    /* Loading */
    .loading { text-align: center; padding: 40px; }
    .spinner {
      width: 40px; height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* é é¢åˆ‡æ› */
    .page { display: none; }
    .page.active { display: block; }
    
    /* é¸å–® */
    .menu-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px; }
    .menu-btn { padding: 16px; border: none; border-radius: 12px; background: #f8f9fa; cursor: pointer; }
    .menu-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .menu-btn-icon { font-size: 28px; margin-bottom: 6px; }
    .menu-btn-text { font-size: 13px; font-weight: 600; }
    
    .error-border { border-color: #dc3545 !important; background-color: #fff8f8; color: #dc3545; }
    .error-text { color: #dc3545 !important; }
    .inventory-info { font-size: 12px; color: #28a745; margin-left: 4px; font-weight: bold; }
    
    /* åˆ—å°æ¨£å¼ */
    @media print {
      @page { size: A4; margin: 10mm; }
      body { background: white !important; padding: 0 !important; min-height: auto !important; }
      .no-print { display: none !important; }
      .container { max-width: 100% !important; }
      .card { box-shadow: none !important; border: 1px solid #ddd; margin-bottom: 0 !important; padding: 12px !important; page-break-inside: avoid; }
      .page { display: none !important; }
      .page.active { display: block !important; }
      .completed-badge { padding: 6px !important; }
      .completed-icon { font-size: 28px !important; }
      .completed-title { font-size: 16px !important; }
      .qr-image { width: 130px !important; height: 130px !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- è¼‰å…¥ä¸­ -->
    <div id="page-loading" class="page active">
      <div class="card">
        <div class="loading">
          <div class="spinner"></div>
          <p>è¼‰å…¥ä¸­...</p>
        </div>
      </div>
    </div>
    
    <!-- ä¸»é¸å–® -->
    <div id="page-menu" class="page">
      <div class="card">
        <div class="card-title">ğŸ“¦ ç‰©æµè¿½è¹¤ç³»çµ±1.1.15</div>
        <p id="welcome-message">æ­¡è¿ä½¿ç”¨ï¼</p>
        <div class="menu-buttons">
          <button class="menu-btn" onclick="showPage('create')">
            <div class="menu-btn-icon">ğŸ“</div>
            <div class="menu-btn-text">å»ºç«‹åŒ…è£¹</div>
          </button>
          <button class="menu-btn" onclick="startScan()">
            <div class="menu-btn-icon">ğŸ“·</div>
            <div class="menu-btn-text">æƒç¢¼ç°½æ”¶</div>
          </button>
          <button class="menu-btn" onclick="showPage('query')">
            <div class="menu-btn-icon">ğŸ”</div>
            <div class="menu-btn-text">æŸ¥è©¢åŒ…è£¹</div>
          </button>
          <button class="menu-btn" onclick="showPage('history')">
            <div class="menu-btn-icon">ğŸ“‹</div>
            <div class="menu-btn-text">ç°½æ”¶ç´€éŒ„</div>
          </button>
        </div>
      </div>
    </div>
    
    <!-- å»ºç«‹åŒ…è£¹ -->
    <div id="page-create" class="page">
      <div class="card">
        <div class="card-title">ğŸ“ å»ºç«‹æ–°åŒ…è£¹</div>
        
        <div class="input-group">
          <label class="input-label">åˆä½œå¤¥ä¼´ï¼ˆå» å®¶ï¼‰</label>
          <div style="display: flex; gap: 8px; margin-bottom: 8px;">
            <button class="btn btn-secondary" onclick="document.getElementById('upload-image').click()" style="margin: 0; background: #e9ecef;">ğŸ“· æ‹ç…§è¾¨è­˜</button>
            <input type="file" id="upload-image" accept="image/*" style="display: none;" onchange="handleImageUpload(this)">
          </div>
          <select id="input-partner" class="input-field" onchange="updateAllInventoryDisplays()">
            <option value="">è¼‰å…¥ä¸­...</option>
          </select>
        </div>
        
        <div class="input-group">
          <label class="input-label">æ”¶ä»¶è€…</label>
          <input type="text" id="input-receiver" class="input-field" placeholder="æ”¶ä»¶äººå§“å">
        </div>
        
        <div class="input-group">
          <label class="input-label">å“é …æ˜ç´°</label>
          <div style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 14px;">ç¸½åŒ…è£¹æ•¸é‡ï¼š</span>
            <select id="input-total-packages" class="input-field" style="width: 80px;">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
              <option value="6">6</option>
              <option value="7">7</option>
              <option value="8">8</option>
              <option value="9">9</option>
              <option value="10">10</option>
            </select>
          </div>
          <div id="items-container">
            <div class="item-entry" data-index="0">
              <div style="display: grid; grid-template-columns: 1fr 1fr 70px; gap: 6px; margin-bottom: 6px;">
                <select class="input-field item-category" onchange="updateModelOptions(this)">
                  <option value="">é¡åˆ¥</option>
                  <option value="db">DB</option>
                  <option value="lb">LB</option>
                  <option value="hdp">Hard Docking Plate</option>
                </select>
                <select class="input-field item-model">
                  <option value="">å‹è™Ÿ</option>
                </select>
                <select class="input-field item-quantity">
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10</option>
                </select>
              </div>
              <input type="text" class="input-field item-accessory" placeholder="é…ä»¶/å‚™è¨»ï¼ˆé¸å¡«ï¼‰">
            </div>
          </div>
          <button class="add-item-btn" onclick="addItem()">+ æ–°å¢å“é …</button>
        </div>
        
        <button class="btn btn-primary" onclick="createPackage()">ç¢ºèªå»ºç«‹</button>
        <button class="btn btn-secondary" onclick="showPage('menu')">è¿”å›</button>
      </div>
    </div>
    
    <!-- å»ºç«‹æˆåŠŸ + QR Code -->
    <div id="page-created" class="page">
      <div class="card" id="print-area">
        <div class="completed-badge">
          <div class="completed-icon">âœ…</div>
          <div class="completed-title">åŒ…è£¹å»ºç«‹æˆåŠŸï¼</div>
        </div>
        
        <div class="info-row">
          <span class="info-label">å–®è™Ÿ</span>
          <span class="info-value" id="created-order-id">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">å» å®¶</span>
          <span class="info-value" id="created-partner">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">æ”¶ä»¶è€…</span>
          <span class="info-value" id="created-receiver">-</span>
        </div>
        
        <div class="items-list" id="created-items"></div>
        
        <div class="qr-container">
          <p>è«‹å°‡æ­¤ QR Code è²¼åœ¨åŒ…è£¹ä¸Š</p>
          <img id="created-qr-image" class="qr-image" src="" alt="QR Code">
        </div>

        <div class="no-print" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
          <div class="input-group">
            <label class="input-label">å¯„é€ Email</label>
            <div style="display: flex; gap: 6px;">
              <input type="text" id="input-email-prefix" class="input-field" placeholder="å¸³è™Ÿ" style="flex: 1;">
              <span style="line-height: 44px; font-size: 14px;">@gmt.com.tw</span>
            </div>
          </div>
          
          <button class="btn btn-primary" onclick="sendEmail()">ğŸ“§ å¯„é€ Email</button>
          <button class="btn btn-secondary" onclick="printPage()" style="background: #17a2b8; color: white;">ğŸ–¨ï¸ åˆ—å°æ­¤é </button>
          <button class="btn btn-secondary" onclick="showPage('menu')">å®Œæˆ</button>
        </div>
      </div>
    </div>
    
    <!-- æŸ¥è©¢åŒ…è£¹ -->
    <div id="page-query" class="page">
      <div class="card">
        <div class="card-title">ğŸ” æŸ¥è©¢åŒ…è£¹</div>
        <div id="query-results" style="margin-top: 0;"></div>
        <button class="btn btn-secondary" onclick="showPage('menu')">è¿”å›</button>
      </div>
    </div>
    
    <!-- ç°½æ”¶é é¢ -->
    <div id="page-sign" class="page">
      <div class="card">
        <div class="card-title">ğŸ“¦ åŒ…è£¹ç°½æ”¶</div>
        
        <div class="info-row">
          <span class="info-label">å–®è™Ÿ</span>
          <span class="info-value" id="sign-order-id">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">å» å®¶</span>
          <span class="info-value" id="sign-partner">-</span>
        </div>
        
        <div class="items-list" id="sign-items"></div>
        
        <div class="card-title" style="margin-top: 12px;">ğŸ“ ç°½æ”¶é€²åº¦ï¼ˆé»æ“Šé¸æ“‡ï¼‰</div>
        <div id="sign-progress"></div>
        
        <div class="input-group" id="name-input-group" style="display: none;">
          <label class="input-label">æ‚¨çš„å§“å</label>
          <input type="text" id="input-signer-name" class="input-field" placeholder="è«‹è¼¸å…¥å§“å">
          <div class="input-hint" id="name-hint"></div>
        </div>
        
        <button class="btn btn-primary" id="btn-confirm-sign" onclick="confirmSign()">ç¢ºèªç°½æ”¶</button>
        <button class="btn btn-secondary" id="btn-sign-back" onclick="showPage('menu')">è¿”å›</button>
      </div>
    </div>
    
    <!-- ç°½æ”¶æˆåŠŸ -->
    <div id="page-sign-complete" class="page">
      <div class="card">
        <div class="completed-badge">
          <div class="completed-icon">âœ…</div>
          <div class="completed-title" id="sign-complete-title">ç°½æ”¶æˆåŠŸï¼</div>
        </div>
        <div id="sign-complete-details"></div>
        <button class="btn btn-primary" id="btn-complete-back" onclick="showPage('menu')">è¿”å›é¦–é </button>
      </div>
    </div>
    
    <!-- å·²å®Œæˆ -->
    <div id="page-completed" class="page">
      <div class="card">
        <div class="completed-badge">
          <div class="completed-icon">ğŸ‰</div>
          <div class="completed-title">ç‰©æµå·²å®Œæˆï¼</div>
        </div>
        <div id="completed-details"></div>
        <button class="btn btn-primary" id="btn-completed-back" onclick="showPage('menu')">è¿”å›é¦–é </button>
      </div>
    </div>
    
    <!-- æ­·å²ç´€éŒ„ -->
    <div id="page-history" class="page">
      <div class="card">
        <div class="card-title">ğŸ“‹ è¿‘å…©é€±ç°½æ”¶ç´€éŒ„</div>
        <div id="history-list" class="items-list" style="background: white; padding: 0;">
          <p style="text-align: center; color: #666; padding: 20px;">è¼‰å…¥ä¸­...</p>
        </div>
        <button class="btn btn-secondary" onclick="showPage('menu')">è¿”å›</button>
      </div>
    </div>
    
  </div>

  <script>
    // ============ è¨­å®š ============
    const CONFIG = {
      LIFF_ID: '2008586810-kB2lZW95',
      GAS_URL: 'https://script.google.com/macros/s/AKfycbzKqViPmHPpIUjL3Uh8pIBzKzn09isIaD3Q37JrleeotvuKlGxBWf4DT86OWZywzHBO/exec'
    };

    const SETTINGS = {
      REQUIRE_NAME: false  // æ˜¯å¦éœ€è¦è¼¸å…¥ç°½æ”¶è€…å§“å
    };

    // å…¨åŸŸè®Šæ•¸
    let currentUser = { lineUserId: '', name: '', preferredRole: '' };
    let currentPackage = null;
    let currentSignStatus = null;
    let selectedRole = null;
    let itemIndex = 1;
    let isDirectAccess = false; // æ˜¯å¦ç‚ºç›´æ¥æƒç¢¼é€²å…¥
    let FORM_OPTIONS = { db: [], lb: [], hdp: [], inventory: {} }; // è¡¨å–®é¸é …

    // ============ LIFF åˆå§‹åŒ– ============
    async function initializeLiff() {
      console.log('é–‹å§‹ LIFF åˆå§‹åŒ–...');
      try {
        console.log('å‘¼å« liff.init...');
        await liff.init({ liffId: CONFIG.LIFF_ID });
        console.log('liff.init å®Œæˆ');
        
        // æª¢æŸ¥ URL åƒæ•¸
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('orderId');
        console.log('URL orderId:', orderId);
        
        if (orderId) {
          isDirectAccess = true;
        }
        
        if (liff.isLoggedIn()) {
          console.log('LIFF å·²ç™»å…¥');
          try {
            const profile = await liff.getProfile();
            console.log('å–å¾— Profile:', profile);
            currentUser.lineUserId = profile.userId;
            currentUser.name = profile.displayName;
          } catch (e) {
            console.error('ç„¡æ³•å–å¾— LINE è³‡è¨Š', e);
            currentUser.lineUserId = 'anonymous_' + Date.now();
            currentUser.name = 'è¨ªå®¢';
          }
        } else {
          console.log('LIFF æœªç™»å…¥');
          // å¦‚æœæœ‰å–®è™Ÿ (æƒç¢¼é€²å…¥)ï¼Œå…è¨±è¨ªå®¢æ¨¡å¼ï¼Œä¸å¼·åˆ¶ç™»å…¥
          if (orderId) {
            console.log('æœ‰å–®è™Ÿï¼Œä½¿ç”¨è¨ªå®¢æ¨¡å¼');
            currentUser.lineUserId = 'guest_' + Date.now();
            currentUser.name = 'è¨ªå®¢';
          } else {
            // æ²’æœ‰å–®è™Ÿ (é€²å…¥ä¸»é¸å–®)ï¼Œå¼·åˆ¶ç™»å…¥
            console.log('ç„¡å–®è™Ÿï¼Œå¼·åˆ¶ç™»å…¥');
            liff.login();
            return;
          }
        }
        
        if (orderId) {
          console.log('è¼‰å…¥åŒ…è£¹:', orderId);
          await loadPackageForSign(orderId);
        } else {
          console.log('é¡¯ç¤ºä¸»é¸å–®');
          showPage('menu');
        }
        
      } catch (error) {
        console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
        alert('LIFF åˆå§‹åŒ–å¤±æ•—: ' + error.message);
        currentUser.lineUserId = 'test_' + Date.now();
        currentUser.name = 'æ¸¬è©¦ç”¨æˆ¶';
        showPage('menu');
      }
    }

    // ============ é é¢æ§åˆ¶ ============
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + pageId).classList.add('active');
      
      if (pageId === 'menu') {
        const welcomeEl = document.getElementById('welcome-message');
        welcomeEl.textContent = currentUser.name ? `æ­¡è¿ï¼Œ${currentUser.name}ï¼` : 'æ­¡è¿ä½¿ç”¨ï¼';
      }
      
      if (pageId === 'sign') {
        const nameGroup = document.getElementById('name-input-group');
        nameGroup.style.display = SETTINGS.REQUIRE_NAME ? 'block' : 'none';
      }
      
      if (pageId === 'history') {
        loadHistory();
      }
      
      if (pageId === 'query') {
        queryPending();
      }
    }

    // ============ API å‘¼å«ï¼ˆJSONPï¼‰============
    function apiGet(action, params = {}) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        const url = new URL(CONFIG.GAS_URL);
        url.searchParams.set('action', action);
        url.searchParams.set('callback', callbackName);
        
        Object.keys(params).forEach(key => {
          const value = params[key];
          if (typeof value === 'object') {
            url.searchParams.set(key, JSON.stringify(value));
          } else {
            url.searchParams.set(key, value);
          }
        });
        
        console.log('API Request:', url.toString());
        
        const timeout = setTimeout(() => {
          cleanup();
          reject(new Error('è«‹æ±‚è¶…æ™‚'));
        }, 60000);
        
        let script;
        
        const cleanup = () => {
          clearTimeout(timeout);
          delete window[callbackName];
          if (script && script.parentNode) {
            script.parentNode.removeChild(script);
          }
        };
        
        window[callbackName] = (data) => {
          console.log('API Response:', data);
          cleanup();
          resolve(data);
        };
        
        script = document.createElement('script');
        script.src = url.toString();
        script.onerror = () => {
          cleanup();
          reject(new Error('ç¶²è·¯è«‹æ±‚å¤±æ•—'));
        };
        
        document.head.appendChild(script);
      });
    }

    function apiPost(action, data) {
      const params = {};
      Object.keys(data).forEach(key => {
        const value = data[key];
        params[key] = typeof value === 'object' ? JSON.stringify(value) : value;
      });
      return apiGet(action, params);
    }

    // ============ å»ºç«‹åŒ…è£¹ ============
    // ============ åœ–ç‰‡è™•ç† ============
    // å°ˆé–€ç”¨æ–¼å‚³é€å¤§é‡è³‡æ–™ (å¦‚åœ–ç‰‡) çš„ POST å‡½å¼
    async function postToGAS(action, data) {
      const url = CONFIG.GAS_URL;
      const payload = { ...data, action: action };
      
      // ä½¿ç”¨ fetch ç™¼é€ POST è«‹æ±‚
      // æ³¨æ„ï¼šä¸è¨­å®š Content-Type ç‚º application/json ä»¥é¿å… CORS é æª¢è«‹æ±‚ (Preflight)
      const response = await fetch(url, {
        method: 'POST',
        body: JSON.stringify(payload)
      });
      
      if (!response.ok) {
        throw new Error('ç¶²è·¯è«‹æ±‚å¤±æ•—: ' + response.status);
      }
      
      return await response.json();
    }

    async function handleImageUpload(input) {
      if (!input.files || !input.files[0]) return;
      
      const file = input.files[0];
      showPage('loading');
      
      try {
        // å£“ç¸®åœ–ç‰‡ (é¿å…è¶…é GAS é™åˆ¶)
        const base64 = await compressImage(file);
        
        // å‘¼å« GAS (æ”¹ç”¨ postToGAS)
        const result = await postToGAS('parseImage', { image: base64 });
        
        if (result.error) {
          alert('è¾¨è­˜å¤±æ•—ï¼š' + result.error);
        } else {
          // å¡«å…¥è¡¨å–®
          if (result.partner) {
            const select = document.getElementById('input-partner');
            // æª¢æŸ¥é¸é …æ˜¯å¦å­˜åœ¨
            const exists = Array.from(select.options).some(o => o.value === result.partner);
            if (exists) select.value = result.partner;
          }
          
          if (result.receiver) document.getElementById('input-receiver').value = result.receiver;
          
          if (result.items && result.items.length > 0) {
            document.getElementById('items-container').innerHTML = ''; // æ¸…ç©º
            itemIndex = 0;
            result.items.forEach(item => {
              addItem(); // æ–°å¢ä¸€åˆ—
              const entries = document.querySelectorAll('.item-entry');
              const lastEntry = entries[entries.length - 1];
              
              // å˜—è©¦åŒ¹é…å‹è™Ÿ
              let category = '';
              let model = item.model || '';
              
              // ç°¡å–®åŒ¹é…é‚è¼¯
              if (FORM_OPTIONS.db.includes(model)) category = 'db';
              else if (FORM_OPTIONS.lb.includes(model)) category = 'lb';
              else if (FORM_OPTIONS.hdp.includes(model)) category = 'hdp';
              
              if (category) {
                const catSelect = lastEntry.querySelector('.item-category');
                catSelect.value = category;
                updateModelOptions(catSelect); // æ›´æ–°å‹è™Ÿé¸å–®
                lastEntry.querySelector('.item-model').value = model;
              } else {
                // å¦‚æœæ‰¾ä¸åˆ°å‹è™Ÿï¼Œå°‡è¾¨è­˜åˆ°çš„å‹è™Ÿæ”¾å…¥å‚™è¨»
                if (model) {
                  const noteInput = lastEntry.querySelector('.item-note');
                  noteInput.value = `(è¾¨è­˜å‹è™Ÿ: ${model}) ` + noteInput.value;
                }
              }
              
              lastEntry.querySelector('.item-quantity').value = item.quantity || 1;
              if (item.accessory) {
                lastEntry.querySelector('.item-note').value += item.accessory;
              }
            });
          }
          alert('âœ… è¾¨è­˜å®Œæˆï¼è«‹ç¢ºèªè³‡æ–™æ˜¯å¦æ­£ç¢ºã€‚');
        }
      } catch (e) {
        alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + e.message);
      }
      
      showPage('create');
      input.value = ''; // é‡ç½® input
    }

    function compressImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // è¨­å®šæœ€å¤§å¯¬åº¦ (800px è¶³å¤ è¾¨è­˜æ–‡å­—)
            const MAX_WIDTH = 800;
            let width = img.width;
            let height = img.height;
            
            if (width > MAX_WIDTH) {
              height *= MAX_WIDTH / width;
              width = MAX_WIDTH;
            }
            
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            
            // è½‰æˆ Base64 (JPEG, 0.7 å“è³ª)
            const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
            resolve(dataUrl.split(',')[1]); // åªå›å‚³ Base64 å­—ä¸²éƒ¨åˆ†
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    async function createPackage() {
      const partnerSelect = document.getElementById('input-partner');
      const partner = partnerSelect.value;
      const receiverInput = document.getElementById('input-receiver');
      const receiver = receiverInput.value.trim();
      const totalPackages = document.getElementById('input-total-packages').value;
      
      let isValid = true;

      if (!partner) {
        partnerSelect.classList.add('error-border');
        isValid = false;
      } else {
        partnerSelect.classList.remove('error-border');
      }

      if (!receiver) {
        receiverInput.classList.add('error-border');
        isValid = false;
      } else {
        receiverInput.classList.remove('error-border');
      }
      
      const items = [];
      document.querySelectorAll('.item-entry').forEach(entry => {
        const categorySelect = entry.querySelector('.item-category');
        const modelSelect = entry.querySelector('.item-model');
        const quantity = entry.querySelector('.item-quantity').value;
        const note = entry.querySelector('.item-note') ? entry.querySelector('.item-note').value.trim() : '';
        
        const category = categorySelect.value;
        const model = modelSelect.value;

        if (!category) {
           categorySelect.classList.add('error-border');
           isValid = false;
        } else {
           categorySelect.classList.remove('error-border');
        }

        if (!model) {
           modelSelect.classList.add('error-border');
           isValid = false;
        } else {
           modelSelect.classList.remove('error-border');
        }
        
        if (category && model) {
          items.push({ category, model, quantity, note });
        }
      });
      
      if (!isValid) {
        alert('è«‹æª¢æŸ¥ç´…è‰²æ¨™ç¤ºçš„æ¬„ä½ï¼Œå¿…é ˆé¸æ“‡æˆ–å¡«å¯«');
        return;
      }
      
      if (items.length === 0) {
        alert('è«‹è‡³å°‘å¡«å¯«ä¸€å€‹å®Œæ•´å“é …ï¼ˆéœ€é¸æ“‡é¡åˆ¥èˆ‡å‹è™Ÿï¼‰');
        return;
      }
      
      showPage('loading');
      
      try {
        const result = await apiPost('createPackage', {
          partner, receiver, items, totalPackages,
          lineUserId: currentUser.lineUserId,
          lineName: currentUser.name
        });
        
        if (result.success) {
          currentPackage = { orderId: result.orderId, partner, receiver, items, qrCodeUrl: result.qrCodeUrl };
          
          document.getElementById('created-order-id').textContent = result.orderId;
          document.getElementById('created-partner').textContent = partner;
          document.getElementById('created-receiver').textContent = receiver;
          
          const itemsHtml = items.map(item => `
            <div class="item-row">
              <span>${item.category} - ${item.model}${item.note ? ' (' + item.note + ')' : ''}</span>
              <span>Ã— ${item.quantity}</span>
            </div>
          `).join('');
          document.getElementById('created-items').innerHTML = itemsHtml;
          document.getElementById('created-qr-image').src = result.qrCodeUrl;
          
          showPage('created');
          
          // æ¸…ç©ºè¡¨å–®
          document.getElementById('input-partner').value = '';
          document.getElementById('input-partner').classList.remove('error-border');
          document.getElementById('input-receiver').value = '';
          document.getElementById('input-receiver').classList.remove('error-border');
          document.getElementById('input-total-packages').value = '1';
          document.getElementById('items-container').innerHTML = `
            <div class="item-entry" data-index="0">
              <div style="display: grid; grid-template-columns: 1fr 1fr 70px; gap: 6px; margin-bottom: 6px;">
                <select class="input-field item-category" onchange="updateModelOptions(this)">
                  <option value="">é¡åˆ¥</option>
                  <option value="db">DB</option>
                  <option value="lb">LB</option>
                  <option value="hdp">Hard Docking Plate</option>
                </select>
                <select class="input-field item-model" onchange="updateInventoryDisplay(this)">
                  <option value="">å‹è™Ÿ</option>
                </select>
                <select class="input-field item-quantity">
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
                  <option value="6">6</option>
                  <option value="7">7</option>
                  <option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10</option>
                </select>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <input type="text" class="input-field item-note" placeholder="å‚™è¨»" style="margin-top: 6px; flex: 1;">
                <span class="inventory-info"></span>
              </div>
            </div>
          `;
          itemIndex = 1;
        } else {
          alert('å»ºç«‹å¤±æ•—ï¼š' + result.error);
          showPage('create');
        }
      } catch (error) {
        alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
        showPage('create');
      }
    }

    // ============ Email ============
    async function sendEmail() {
      const prefix = document.getElementById('input-email-prefix').value.trim();
      if (!prefix) {
        alert('è«‹è¼¸å…¥ Email å¸³è™Ÿ');
        return;
      }
      
      const toEmail = prefix + '@gmt.com.tw';
      
      try {
        const result = await apiPost('sendPackageEmail', {
          toEmail,
          orderId: currentPackage.orderId,
          partner: currentPackage.partner,
          receiver: currentPackage.receiver,
          items: currentPackage.items,
          qrCodeUrl: currentPackage.qrCodeUrl
        });
        
        alert(result.success ? 'Email å·²å¯„å‡ºï¼' : 'å¯„é€å¤±æ•—ï¼š' + result.error);
      } catch (error) {
        alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
      }
    }

    function printPage() {
      window.print();
    }

    // ============ æƒç¢¼ ============
    async function startScan() {
      try {
        if (liff.scanCodeV2) {
          const result = await liff.scanCodeV2();
          if (result.value) {
            const url = new URL(result.value);
            const orderId = url.searchParams.get('orderId');
            if (orderId) {
              await loadPackageForSign(orderId);
            } else {
              alert('ç„¡æ•ˆçš„ QR Code');
            }
          }
        } else {
          const orderId = prompt('è«‹è¼¸å…¥å–®è™Ÿï¼ˆæ¸¬è©¦ç”¨ï¼‰ï¼š');
          if (orderId) await loadPackageForSign(orderId);
        }
      } catch (error) {
        console.error('æƒç¢¼å¤±æ•—:', error);
        const orderId = prompt('æƒç¢¼å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥å–®è™Ÿï¼š');
        if (orderId) await loadPackageForSign(orderId);
      }
    }

    // ============ æŸ¥è©¢ ============
    async function queryPackage() {
      const orderId = document.getElementById('input-query-order').value.trim();
      if (!orderId) {
        alert('è«‹è¼¸å…¥å–®è™Ÿ');
        return;
      }
      await loadPackageForSign(orderId);
    }
    
    async function queryPending() {
      document.getElementById('query-results').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      
      try {
        const list = await apiGet('getPending');
        if (list.length === 0) {
          document.getElementById('query-results').innerHTML = '<p style="text-align:center; padding:20px;">ç›®å‰æ²’æœ‰å¾…å–ä»¶åŒ…è£¹ ğŸ‰</p>';
          return;
        }
        
        let html = '<div class="card-title" style="font-size:16px;">å¾…å–ä»¶æ¸…å–® (' + list.length + ')</div>';
        list.forEach(item => {
          html += `
            <div class="card" style="border:1px solid #eee; box-shadow:none; margin-bottom:10px; cursor:pointer;" onclick="loadPackageForSign('${item.orderId}', true)">
              <div style="font-weight:bold; color:#667eea;">${item.orderId}</div>
              <div style="font-size:14px; color:#333;">${item.partner} â¡ï¸ ${item.receiver}</div>
              <div style="font-size:12px; color:#999;">${formatTime(item.time)}</div>
            </div>
          `;
        });
        document.getElementById('query-results').innerHTML = html;
        
      } catch (e) {
        document.getElementById('query-results').innerHTML = '<p style="color:red;">è¼‰å…¥å¤±æ•—: ' + e.message + '</p>';
      }
    }
    
    async function loadHistory() {
      const container = document.getElementById('history-list');
      container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      
      try {
        const list = await apiGet('getHistory');
        if (list.length === 0) {
          container.innerHTML = '<p style="text-align:center; padding:20px;">è¿‘å…©é€±æ²’æœ‰ç°½æ”¶ç´€éŒ„</p>';
          return;
        }
        
        let html = '';
        list.forEach(item => {
          let statusColor = '#28a745'; // Completed
          if (item.status === 'é‹é€ä¸­') statusColor = '#ffc107';
          if (item.status === 'å·²å…¥åº«') statusColor = '#17a2b8';
          
          html += `
            <div class="card" style="border:1px solid #eee; box-shadow:none; margin-bottom:10px; cursor:pointer;" onclick="loadPackageForSign('${item.orderId}', true)">
              <div style="display:flex; justify-content:space-between;">
                <div style="font-weight:bold; color:#667eea;">${item.orderId}</div>
                <div style="font-size:12px; padding:2px 6px; border-radius:4px; background:${statusColor}; color:white;">${item.status}</div>
              </div>
              <div style="font-size:14px; color:#333; margin-top:4px;">${item.partner} â¡ï¸ ${item.receiver}</div>
              <div style="font-size:12px; color:#999;">${formatTime(item.time)}</div>
            </div>
          `;
        });
        container.innerHTML = html;
        
      } catch (e) {
        container.innerHTML = '<p style="color:red;">è¼‰å…¥å¤±æ•—: ' + e.message + '</p>';
      }
    }

    // ============ ç°½æ”¶æµç¨‹ ============
    async function loadPackageForSign(orderId, viewOnly = false) {
      showPage('loading');
      
      try {
        const packageInfo = await apiGet('getPackageInfo', { orderId });
        if (packageInfo.error) {
          alert(packageInfo.error);
          showPage('menu');
          return;
        }
        
        const signStatus = await apiGet('getSignStatus', { orderId });
        if (signStatus.error) {
          alert(signStatus.error);
          showPage('menu');
          return;
        }
        
        currentPackage = packageInfo;
        currentSignStatus = signStatus;
        
        // å¦‚æœæ˜¯ã€Œç°½æ”¶æ¨¡å¼ã€ä¸”å·²å®Œæˆï¼Œæ‰é¡¯ç¤ºå®Œæˆé é¢
        // å¦‚æœæ˜¯ã€Œæª¢è¦–æ¨¡å¼ã€(History/Query)ï¼Œå³ä½¿å·²å®Œæˆä¹Ÿé¡¯ç¤ºè©³ç´°é é¢
        if (!viewOnly && signStatus.nextRole === 'completed') {
          showCompletedPage();
          return;
        }
        
        renderSignPage(viewOnly);
      } catch (error) {
        alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        showPage('menu');
      }
    }

    function renderSignPage(viewOnly = false) {
      document.getElementById('sign-order-id').textContent = currentPackage.orderId;
      document.getElementById('sign-partner').textContent = currentPackage.partner;
      
      const itemsHtml = currentPackage.items.map(item => `
        <div class="item-row">
          <span>${item.category ? item.category + ' - ' : ''}${item.model}${item.note ? ' (' + item.note + ')' : ''}</span>
          <span>Ã— ${item.quantity}</span>
        </div>
      `).join('');
      document.getElementById('sign-items').innerHTML = itemsHtml;
      
      selectedRole = currentSignStatus.nextRole;
      document.getElementById('sign-progress').innerHTML = renderProgress(viewOnly);
      
      if (SETTINGS.REQUIRE_NAME) {
        document.getElementById('input-signer-name').value = currentUser.name || '';
      }
      
      // View Only Mode Logic
      const btnConfirm = document.getElementById('btn-confirm-sign');
      const nameGroup = document.getElementById('name-input-group');
      const pageTitle = document.querySelector('#page-sign .card-title');
      
      if (viewOnly) {
        btnConfirm.style.display = 'none';
        nameGroup.style.display = 'none';
        pageTitle.textContent = 'ğŸ“¦ åŒ…è£¹è©³æƒ… (åƒ…ä¾›æª¢è¦–)';
      } else {
        btnConfirm.style.display = 'block';
        if (SETTINGS.REQUIRE_NAME) nameGroup.style.display = 'block';
        pageTitle.textContent = 'ğŸ“¦ åŒ…è£¹ç°½æ”¶';
      }
      
      // å¦‚æœæ˜¯ç›´æ¥æƒç¢¼é€²å…¥ï¼Œéš±è—è¿”å›æŒ‰éˆ•
      const btnBack = document.getElementById('btn-sign-back');
      if (btnBack) btnBack.style.display = isDirectAccess ? 'none' : 'block';
      
      showPage('sign');
    }

    function renderProgress(viewOnly = false) {
      const steps = [
        { key: 'driver', icon: 'ğŸšš', name: 'å¸æ©Ÿ', data: currentSignStatus.driver },
        { key: 'warehouse', icon: 'ğŸ­', name: 'åº«æˆ¿', data: currentSignStatus.warehouse },
        { key: 'engineer', icon: 'ğŸ‘·', name: 'å·¥ç¨‹å¸«', data: currentSignStatus.engineer }
      ];
      
      return steps.map(step => {
        const isCompleted = step.data.name !== '';
        const isAvailable = currentSignStatus.availableRoles.includes(step.key);
        const isSelected = selectedRole === step.key;
        
        let statusClass = '', detail = 'ç­‰å¾…ä¸­', clickHandler = '';
        
        if (isCompleted) {
          statusClass = 'completed disabled';
          detail = `${step.data.name} (${formatTime(step.data.time)})`;
        } else if (isSelected) {
          statusClass = 'selected';
          detail = viewOnly ? 'ç­‰å¾…ç°½æ”¶' : 'â† é»æ“Šç°½æ”¶';
          if (!viewOnly) clickHandler = `onclick="selectRole('${step.key}')"`;
        } else if (isAvailable) {
          statusClass = 'pending';
          detail = viewOnly ? 'ç­‰å¾…ä¸­' : 'é»æ“Šé¸æ“‡';
          if (!viewOnly) clickHandler = `onclick="selectRole('${step.key}')"`;
        } else {
          statusClass = 'disabled';
        }
        
        return `
          <div class="progress-step ${statusClass}" ${clickHandler}>
            <div class="step-icon ${isCompleted ? 'completed' : (isSelected ? 'current' : 'pending')}">${isCompleted ? 'âœ“' : step.icon}</div>
            <div class="step-info">
              <div class="step-title">${step.name}</div>
              <div class="step-detail">${detail}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function selectRole(role) {
      selectedRole = role;
      document.getElementById('sign-progress').innerHTML = renderProgress();
    }

    async function confirmSign() {
      const roleNames = { driver: 'å¸æ©Ÿ', warehouse: 'åº«æˆ¿', engineer: 'å·¥ç¨‹å¸«' };
      let name = SETTINGS.REQUIRE_NAME 
        ? document.getElementById('input-signer-name').value.trim() 
        : roleNames[selectedRole];
      
      if (SETTINGS.REQUIRE_NAME && !name) {
        alert('è«‹è¼¸å…¥æ‚¨çš„å§“å');
        return;
      }
      
      if (!selectedRole) {
        alert('è«‹é¸æ“‡æ‚¨çš„èº«ä»½');
        return;
      }
      
      document.getElementById('btn-confirm-sign').disabled = true;
      
      try {
        const result = await apiPost('signPackage', {
          orderId: currentPackage.orderId,
          role: selectedRole,
          name: name,
          lineUserId: currentUser.lineUserId
        });
        
        if (result.success) {
          document.getElementById('sign-complete-title').textContent = `${roleNames[selectedRole]}ç°½æ”¶æˆåŠŸï¼`;
          
          let detailsHtml = `<div class="info-row"><span class="info-label">å–®è™Ÿ</span><span class="info-value">${currentPackage.orderId}</span></div>`;
          
          const nextRole = result.status.nextRole;
          if (nextRole === 'completed') {
            detailsHtml += `<div style="text-align: center; margin-top: 20px; color: #28a745;"><div style="font-size: 32px;">ğŸ‰</div><div>ç‰©æµè¿½è¹¤å·²å®Œæˆï¼</div></div>`;
          } else {
            detailsHtml += `<div style="text-align: center; margin-top: 20px; color: #667eea;"><div>ğŸ“ ä¸‹ä¸€ç«™ï¼š${roleNames[nextRole]}</div></div>`;
          }
          
          document.getElementById('sign-complete-details').innerHTML = detailsHtml;
          
          // å¦‚æœæ˜¯ç›´æ¥æƒç¢¼é€²å…¥ï¼Œéš±è—è¿”å›æŒ‰éˆ•
          const btnBack = document.getElementById('btn-complete-back');
          if (btnBack) btnBack.style.display = isDirectAccess ? 'none' : 'block';
          
          showPage('sign-complete');
        } else {
          alert('ç°½æ”¶å¤±æ•—ï¼š' + result.error);
        }
      } catch (error) {
        alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
      }
      
      document.getElementById('btn-confirm-sign').disabled = false;
    }

    function showCompletedPage() {
      let detailsHtml = `
        <div class="info-row"><span class="info-label">å–®è™Ÿ</span><span class="info-value">${currentPackage.orderId}</span></div>
        <div class="info-row"><span class="info-label">å» å®¶</span><span class="info-value">${currentPackage.partner}</span></div>
        <hr style="margin: 12px 0; border: none; border-top: 1px solid #eee;">
        <div class="card-title">ğŸ“ ç°½æ”¶æ­·ç¨‹</div>
      `;
      
      const roles = [
        { key: 'driver', icon: 'ğŸšš', name: 'å¸æ©Ÿ', data: currentSignStatus.driver },
        { key: 'warehouse', icon: 'ğŸ­', name: 'åº«æˆ¿', data: currentSignStatus.warehouse },
        { key: 'engineer', icon: 'ğŸ‘·', name: 'å·¥ç¨‹å¸«', data: currentSignStatus.engineer }
      ];
      
      roles.forEach(r => {
        detailsHtml += `
          <div class="progress-step completed">
            <div class="step-icon completed">âœ“</div>
            <div class="step-info">
              <div class="step-title">${r.icon} ${r.name}</div>
              <div class="step-detail">${r.data.name} (${formatTime(r.data.time)})</div>
            </div>
          </div>
        `;
      });
      
      document.getElementById('completed-details').innerHTML = detailsHtml;
      
      // å¦‚æœæ˜¯ç›´æ¥æƒç¢¼é€²å…¥ï¼Œéš±è—è¿”å›æŒ‰éˆ•
      const btnBack = document.getElementById('btn-completed-back');
      if (btnBack) btnBack.style.display = isDirectAccess ? 'none' : 'block';
      
      showPage('completed');
    }

    function formatTime(dateStr) {
      if (!dateStr) return '-';
      try {
        const date = new Date(dateStr);
        return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
      } catch (e) {
        return '-';
      }
    }

    // ============ API å‘¼å« ============
    function apiGet(functionName, params = {}) {
      return new Promise((resolve, reject) => {
        console.log(`[API] Call ${functionName}`, params);
        if (typeof google !== 'undefined' && google.script) {
          google.script.run
            .withSuccessHandler((response) => {
              console.log(`[API] Success ${functionName}`, response);
              resolve(response);
            })
            .withFailureHandler((error) => {
              console.error(`[API] Failure ${functionName}`, error);
              reject(error);
            })
            [functionName](params);
        } else {
          // Fallback to fetch for external hosting (e.g. GitHub Pages)
          console.log(`[API] Fetching ${functionName} via HTTP`);
          const url = new URL(CONFIG.GAS_URL);
          url.searchParams.append('action', functionName);
          Object.keys(params).forEach(key => url.searchParams.append(key, params[key]));
          
          fetch(url)
            .then(res => {
              if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
              return res.json();
            })
            .then(response => {
              console.log(`[API] Success ${functionName}`, response);
              if (response.error) throw new Error(response.error);
              resolve(response);
            })
            .catch(error => {
              console.error(`[API] Failure ${functionName}`, error);
              reject(error);
            });
        }
      });
    }

    function apiPost(functionName, params = {}) {
      return new Promise((resolve, reject) => {
        console.log(`[API] Post ${functionName}`, params);
        if (typeof google !== 'undefined' && google.script) {
          google.script.run
            .withSuccessHandler((response) => {
              console.log(`[API] Success ${functionName}`, response);
              resolve(response);
            })
            .withFailureHandler((error) => {
              console.error(`[API] Failure ${functionName}`, error);
              reject(error);
            })
            [functionName](params);
        } else {
          // Fallback to fetch for external hosting
          console.log(`[API] Posting ${functionName} via HTTP`);
          const payload = { ...params, action: functionName };
          
          fetch(CONFIG.GAS_URL, {
            method: 'POST',
            body: JSON.stringify(payload)
            // Note: Not setting Content-Type to avoid CORS preflight
          })
            .then(res => {
              if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
              return res.json();
            })
            .then(response => {
              console.log(`[API] Success ${functionName}`, response);
              if (response.error) throw new Error(response.error);
              resolve(response);
            })
            .catch(error => {
              console.error(`[API] Failure ${functionName}`, error);
              reject(error);
            });
        }
      });
    }

    // ============ å•Ÿå‹• ============
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOMContentLoaded triggered');
      
      // å…¨åŸŸéŒ¯èª¤è™•ç†
      window.onerror = function(message, source, lineno, colno, error) {
        console.error('Global Error:', message, error);
        alert('ç™¼ç”Ÿæœªé æœŸçš„éŒ¯èª¤: ' + message);
      };
      
      // å¼·åˆ¶è¶…æ™‚ä¿è­·ï¼šå¦‚æœ 15 ç§’å¾Œé‚„åœ¨ loadingï¼Œå¼·åˆ¶é¡¯ç¤ºé¸å–®
      setTimeout(() => {
        const loadingPage = document.getElementById('page-loading');
        if (loadingPage.classList.contains('active')) {
          console.warn('Initialization timed out, forcing menu display');
          alert('ç³»çµ±åˆå§‹åŒ–é€¾æ™‚ï¼Œå°‡å¼·åˆ¶é€²å…¥ä¸»é¸å–®ã€‚éƒ¨åˆ†åŠŸèƒ½å¯èƒ½ç„¡æ³•ä½¿ç”¨ã€‚');
          showPage('menu');
        }
      }, 15000);

      initializeLiff();
      loadFormOptions();
    });
    
    async function loadFormOptions() {
      console.log('é–‹å§‹è¼‰å…¥è¡¨å–®é¸é …...');
      try {
        // è¨­å®š 10 ç§’è¶…æ™‚
        const timeoutPromise = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('è¼‰å…¥é€¾æ™‚')), 10000)
        );
        
        const options = await Promise.race([
          apiGet('getFormOptions'),
          timeoutPromise
        ]);
        
        if (options.error) {
          throw new Error(options.error);
        }
        
        console.log('é¸é …è¼‰å…¥æˆåŠŸ', options);
        FORM_OPTIONS = options;
        
        // å¡«å…¥å» å®¶
        const select = document.getElementById('input-partner');
        select.innerHTML = '<option value="">è«‹é¸æ“‡å» å®¶</option>';
        options.partners.forEach(p => {
          const option = document.createElement('option');
          option.value = p;
          option.textContent = p;
          select.appendChild(option);
        });
        
      } catch (e) {
        console.error('è¼‰å…¥é¸é …å¤±æ•—', e);
        document.getElementById('input-partner').innerHTML = '<option value="">è¼‰å…¥å¤±æ•—: ' + e.message + '</option>';
        alert('è¼‰å…¥è¡¨å–®é¸é …å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œå†è©¦ã€‚\néŒ¯èª¤: ' + e.message);
      }
    }
    
    function updateModelOptions(categorySelect) {
      const category = categorySelect.value;
      const modelSelect = categorySelect.parentElement.querySelector('.item-model');
      modelSelect.innerHTML = '<option value="">å‹è™Ÿ</option>';
      
      if (category && FORM_OPTIONS[category]) {
        FORM_OPTIONS[category].forEach(m => {
          const option = document.createElement('option');
          option.value = m;
          option.textContent = m;
          modelSelect.appendChild(option);
        });
      }
      updateInventoryDisplay(modelSelect);
    }

    function updateInventoryDisplay(element) {
      const entry = element.closest('.item-entry');
      const category = entry.querySelector('.item-category').value;
      const model = entry.querySelector('.item-model').value;
      const partner = document.getElementById('input-partner').value;
      const infoSpan = entry.querySelector('.inventory-info');

      if (!infoSpan) return;

      if (category && model && partner && FORM_OPTIONS.inventory && FORM_OPTIONS.inventory[category]) {
        const modelData = FORM_OPTIONS.inventory[category][model];
        if (modelData && modelData[partner] !== undefined) {
          infoSpan.textContent = `åº«å­˜: ${modelData[partner]}`;
        } else {
          infoSpan.textContent = 'åº«å­˜: -';
        }
      } else {
        infoSpan.textContent = '';
      }
    }

    function updateAllInventoryDisplays() {
      document.querySelectorAll('.item-entry').forEach(entry => {
        const modelSelect = entry.querySelector('.item-model');
        updateInventoryDisplay(modelSelect);
      });
    }
    
    function addItem() {
      itemIndex++;
      const div = document.createElement('div');
      div.className = 'item-entry';
      div.dataset.index = itemIndex;
      div.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr 70px; gap: 6px; margin-bottom: 6px;">
          <select class="input-field item-category" onchange="updateModelOptions(this)">
            <option value="">é¡åˆ¥</option>
            <option value="db">DB</option>
            <option value="lb">LB</option>
            <option value="hdp">Hard Docking Plate</option>
          </select>
          <select class="input-field item-model" onchange="updateInventoryDisplay(this)">
            <option value="">å‹è™Ÿ</option>
          </select>
          <select class="input-field item-quantity">
            ${[1,2,3,4,5,6,7,8,9,10].map(i => `<option value="${i}">${i}</option>`).join('')}
          </select>
        </div>
        <div style="display: flex; gap: 6px; align-items: center;">
          <input type="text" class="input-field item-note" placeholder="å‚™è¨»" style="flex:1;">
          <span class="inventory-info"></span>
          <button class="btn btn-secondary" onclick="this.closest('.item-entry').remove()" style="width:auto; padding:0 10px; background:#dc3545; color:white;">ğŸ—‘ï¸</button>
        </div>
      `;
      document.getElementById('items-container').appendChild(div);
    }
</script>
</body>
</html>
