<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“¦ ç‰©æµè¿½è¹¤ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
    }
    
    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .card-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    
    .info-row:last-child {
      border-bottom: none;
    }
    
    .info-label {
      color: #666;
    }
    
    .info-value {
      font-weight: 600;
      color: #333;
    }
    
    .items-list {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin: 12px 0;
    }
    
    .item-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
    }
    
    /* é€²åº¦æ¢ï¼ˆå¯é»æ“Šé¸æ“‡ï¼‰ */
    .progress-container {
      margin: 20px 0;
    }
    
    .progress-step {
      display: flex;
      align-items: center;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    
    .progress-step:hover:not(.disabled) {
      background: #e9ecef;
    }
    
    .progress-step.completed {
      background: #d4edda;
      cursor: not-allowed;
    }
    
    .progress-step.selected {
      background: #fff3cd;
      border: 2px solid #ffc107;
    }
    
    .progress-step.disabled {
      background: #e9ecef;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .progress-step.pending {
      background: #f8f9fa;
    }
    
    .step-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-right: 12px;
    }
    
    .step-icon.completed { background: #28a745; color: white; }
    .step-icon.current { background: #ffc107; color: white; }
    .step-icon.pending { background: #e9ecef; color: #999; }
    
    .step-info {
      flex: 1;
    }
    
    .step-title {
      font-weight: bold;
    }
    
    .step-detail {
      font-size: 12px;
      color: #666;
    }
    
    /* è§’è‰²é¸æ“‡ */
    .role-selector {
      margin: 16px 0;
    }
    
    .role-option {
      display: flex;
      align-items: center;
      padding: 16px;
      margin: 8px 0;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .role-option:hover:not(.disabled) {
      border-color: #667eea;
      background: #f8f9ff;
    }
    
    .role-option.selected {
      border-color: #667eea;
      background: #667eea;
      color: white;
    }
    
    .role-option.disabled {
      background: #e9ecef;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .role-option.disabled .role-status {
      color: #28a745;
    }
    
    .role-icon {
      font-size: 24px;
      margin-right: 12px;
    }
    
    .role-name {
      font-weight: bold;
      flex: 1;
    }
    
    .role-status {
      font-size: 12px;
    }
    
    /* è¼¸å…¥æ¡† */
    .input-group {
      margin: 16px 0;
    }
    
    .input-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    
    .input-field {
      width: 100%;
      padding: 14px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.2s;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .input-hint {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    
    /* æŒ‰éˆ• */
    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102,126,234,0.4);
    }
    
    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .btn-secondary {
      background: #f8f9fa;
      color: #333;
      margin-top: 12px;
    }
    
    /* å®Œæˆé é¢ */
    .completed-badge {
      text-align: center;
      padding: 40px 20px;
    }
    
    .completed-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }
    
    .completed-title {
      font-size: 24px;
      font-weight: bold;
      color: #28a745;
    }
    
    /* QR Code */
    .qr-container {
      text-align: center;
      padding: 20px;
    }
    
    .qr-image {
      width: 200px;
      height: 200px;
      margin: 16px auto;
      border: 4px solid #667eea;
      border-radius: 12px;
    }
    
    /* æ–°å¢åŒ…è£¹è¡¨å–® */
    .item-entry {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin: 8px 0;
    }
    
    .item-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .remove-item {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
    }
    
    .add-item-btn {
      width: 100%;
      padding: 12px;
      border: 2px dashed #667eea;
      border-radius: 8px;
      background: transparent;
      color: #667eea;
      font-size: 14px;
      cursor: pointer;
      margin: 12px 0;
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* é é¢åˆ‡æ› */
    .page {
      display: none;
    }
    
    .page.active {
      display: block;
    }
    
    /* é¸å–® */
    .menu-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 16px;
    }
    
    .menu-btn {
      padding: 20px;
      border: none;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .menu-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .menu-btn-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    
    .menu-btn-text {
      font-size: 14px;
      font-weight: 600;
    }

    /* éŒ¯èª¤è¨Šæ¯ */
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 12px;
      border-radius: 8px;
      margin: 12px 0;
      text-align: center;
    }

    /* åˆ—å°æ¨£å¼ */
    @media print {
      body {
        background: white !important;
        padding: 0 !important;
      }
      
      .no-print {
        display: none !important;
      }
      
      .card {
        box-shadow: none !important;
        border: 1px solid #ddd;
      }
      
      .page {
        display: none !important;
      }
      
      .page.active {
        display: block !important;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    
    <!-- è¼‰å…¥ä¸­ -->
    <div id="page-loading" class="page active">
      <div class="card">
        <div class="loading">
          <div class="spinner"></div>
          <p>è¼‰å…¥ä¸­...</p>
        </div>
      </div>
    </div>
    
    <!-- ä¸»é¸å–® -->
    <div id="page-menu" class="page">
      <div class="card">
        <div class="card-title">ğŸ“¦ ç‰©æµè¿½è¹¤ç³»çµ±</div>
        <p id="welcome-message">æ­¡è¿ä½¿ç”¨ï¼</p>
        <div class="menu-buttons">
          <button class="menu-btn" onclick="showPage('create')">
            <div class="menu-btn-icon">ğŸ“</div>
            <div class="menu-btn-text">å»ºç«‹åŒ…è£¹</div>
          </button>
          <button class="menu-btn" onclick="startScan()">
            <div class="menu-btn-icon">ğŸ“·</div>
            <div class="menu-btn-text">æƒç¢¼ç°½æ”¶</div>
          </button>
          <button class="menu-btn" onclick="showPage('query')">
            <div class="menu-btn-icon">ğŸ”</div>
            <div class="menu-btn-text">æŸ¥è©¢åŒ…è£¹</div>
          </button>
          <button class="menu-btn" onclick="showPage('history')">
            <div class="menu-btn-icon">ğŸ“‹</div>
            <div class="menu-btn-text">ç°½æ”¶ç´€éŒ„</div>
          </button>
        </div>
      </div>
    </div>
    
    <!-- å»ºç«‹åŒ…è£¹ -->
    <div id="page-create" class="page">
      <div class="card">
        <div class="card-title">ğŸ“ å»ºç«‹æ–°åŒ…è£¹</div>
        
        <div class="input-group">
          <label class="input-label">åˆä½œå¤¥ä¼´ï¼ˆå» å®¶ï¼‰</label>
          <input type="text" id="input-partner" class="input-field" placeholder="ä¾‹å¦‚ï¼šè¶…è±">
        </div>
        
        <div class="input-group">
          <label class="input-label">æ”¶ä»¶è€…</label>
          <input type="text" id="input-receiver" class="input-field" placeholder="æ”¶ä»¶äººå§“å">
        </div>
        
        <div class="input-group">
          <label class="input-label">å“é …æ˜ç´°</label>
          <div id="items-container">
            <div class="item-entry" data-index="0">
              <div style="display: grid; grid-template-columns: 1fr 80px; gap: 8px;">
                <input type="text" class="input-field item-model" placeholder="ç”¢å“å‹è™Ÿ">
                <input type="number" class="input-field item-quantity" placeholder="æ•¸é‡" min="1" value="1">
              </div>
              <input type="text" class="input-field item-accessory" placeholder="é…ä»¶ï¼ˆé¸å¡«ï¼‰" style="margin-top: 8px;">
            </div>
          </div>
          <button class="add-item-btn" onclick="addItem()">+ æ–°å¢å“é …</button>
        </div>
        
        <button class="btn btn-primary" onclick="createPackage()">ç¢ºèªå»ºç«‹</button>
        <button class="btn btn-secondary" onclick="showPage('menu')">è¿”å›</button>
      </div>
    </div>
    
    <!-- å»ºç«‹æˆåŠŸ + QR Code -->
    <div id="page-created" class="page">
      <div class="card" id="print-area">
        <div class="completed-badge">
          <div class="completed-icon">âœ…</div>
          <div class="completed-title">åŒ…è£¹å»ºç«‹æˆåŠŸï¼</div>
        </div>
        
        <div class="info-row">
          <span class="info-label">å–®è™Ÿ</span>
          <span class="info-value" id="created-order-id">-</span>
        </div>
        
        <div class="info-row">
          <span class="info-label">å» å®¶</span>
          <span class="info-value" id="created-partner">-</span>
        </div>
        
        <div class="info-row">
          <span class="info-label">æ”¶ä»¶è€…</span>
          <span class="info-value" id="created-receiver">-</span>
        </div>
        
        <div class="items-list" id="created-items">
          <!-- å“é …åˆ—è¡¨ -->
        </div>
        
        <div class="qr-container">
          <p>è«‹å°‡æ­¤ QR Code è²¼åœ¨åŒ…è£¹ä¸Š</p>
          <img id="created-qr-image" class="qr-image" src="" alt="QR Code">
        </div>
      </div>
      
      <!-- æŒ‰éˆ•å€ï¼ˆåˆ—å°æ™‚éš±è—ï¼‰ -->
      <div class="card no-print">
        <div class="input-group">
          <label class="input-label">å¯„é€ Email</label>
          <div style="display: flex; gap: 8px;">
            <input type="text" id="input-email-prefix" class="input-field" placeholder="è¼¸å…¥å¸³è™Ÿ" style="flex: 1;">
            <span style="line-height: 48px;">@gmt.com.tw</span>
          </div>
        </div>
        
        <button class="btn btn-primary" onclick="sendEmail()">ğŸ“§ å¯„é€ Email</button>
        <button class="btn btn-secondary" onclick="printPage()" style="background: #17a2b8; color: white;">ğŸ–¨ï¸ åˆ—å°æ­¤é </button>
        <button class="btn btn-secondary" onclick="showPage('menu')">å®Œæˆ</button>
      </div>
    </div>
    
    <!-- æŸ¥è©¢åŒ…è£¹ -->
    <div id="page-query" class="page">
      <div class="card">
        <div class="card-title">ğŸ” æŸ¥è©¢åŒ…è£¹</div>
        
        <div class="input-group">
          <label class="input-label">è¼¸å…¥å–®è™Ÿ</label>
          <input type="text" id="input-query-order" class="input-field" placeholder="ä¾‹å¦‚ï¼š20251128-143022">
        </div>
        
        <button class="btn btn-primary" onclick="queryPackage()">æŸ¥è©¢</button>
        <button class="btn btn-secondary" onclick="showPage('menu')">è¿”å›</button>
      </div>
    </div>
    
    <!-- ç°½æ”¶é é¢ -->
    <div id="page-sign" class="page">
      <div class="card">
        <div class="card-title">ğŸ“¦ åŒ…è£¹ç°½æ”¶</div>
        
        <div class="info-row">
          <span class="info-label">å–®è™Ÿ</span>
          <span class="info-value" id="sign-order-id">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">å» å®¶</span>
          <span class="info-value" id="sign-partner">-</span>
        </div>
        
        <div class="items-list" id="sign-items">
          <!-- å“é …åˆ—è¡¨ -->
        </div>
        
        <!-- é€²åº¦ï¼ˆå¯é»æ“Šé¸æ“‡ï¼‰ -->
        <div class="progress-container" id="sign-progress">
          <!-- å‹•æ…‹ç”¢ç”Ÿ -->
        </div>
        
        <!-- å§“åè¼¸å…¥ -->
        <div class="input-group" id="name-input-group">
          <label class="input-label">æ‚¨çš„å§“å</label>
          <input type="text" id="input-signer-name" class="input-field" placeholder="è«‹è¼¸å…¥å§“å">
          <p class="input-hint" id="name-hint"></p>
        </div>
        
        <button class="btn btn-primary" id="btn-confirm-sign" onclick="confirmSign()">ç¢ºèªç°½æ”¶</button>
        <button class="btn btn-secondary" onclick="showPage('menu')">è¿”å›</button>
      </div>
    </div>
    
    <!-- ç°½æ”¶å®Œæˆ -->
    <div id="page-sign-complete" class="page">
      <div class="card">
        <div class="completed-badge">
          <div class="completed-icon">ğŸ‰</div>
          <div class="completed-title" id="sign-complete-title">ç°½æ”¶æˆåŠŸï¼</div>
        </div>
        
        <div id="sign-complete-details">
          <!-- å‹•æ…‹å…§å®¹ -->
        </div>
        
        <button class="btn btn-primary" onclick="showPage('menu')">å®Œæˆ</button>
      </div>
    </div>
    
    <!-- å·²å®Œæˆé é¢ -->
    <div id="page-completed" class="page">
      <div class="card">
        <div class="completed-badge">
          <div class="completed-icon">âœ…</div>
          <div class="completed-title">æ­¤åŒ…è£¹å·²å®Œæˆç°½æ”¶</div>
        </div>
        
        <div id="completed-details">
          <!-- å‹•æ…‹å…§å®¹ -->
        </div>
        
        <button class="btn btn-primary" onclick="showPage('menu')">è¿”å›ä¸»é¸å–®</button>
      </div>
    </div>
    
  </div>

  <script>
    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘                      ğŸ”§ ç³»çµ±è¨­å®šå€                              â•‘
    // â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
    // â•‘  REQUIRE_LOGIN_FOR_CREATE: å»ºç«‹åŒ…è£¹æ™‚æ˜¯å¦éœ€è¦ LINE ç™»å…¥         â•‘
    // â•‘    - true  = éœ€è¦ç™»å…¥ï¼ˆè¨˜éŒ„å»ºç«‹è€… LINE ID å’Œåç¨±ï¼‰              â•‘
    // â•‘    - false = å…ç™»å…¥                                            â•‘
    // â•‘                                                                â•‘
    // â•‘  REQUIRE_LOGIN_FOR_SIGN: ç°½æ”¶æ™‚æ˜¯å¦éœ€è¦ LINE ç™»å…¥              â•‘
    // â•‘    - true  = éœ€è¦ç™»å…¥ï¼ˆå¯è¨˜ä½ä½¿ç”¨è€…å§“åï¼Œè¿½è¹¤ LINE IDï¼‰          â•‘
    // â•‘    - false = å…ç™»å…¥ï¼ˆä»»ä½•äººæƒç¢¼å³å¯ä½¿ç”¨ï¼‰                        â•‘
    // â•‘                                                                â•‘
    // â•‘  REQUIRE_NAME: ç°½æ”¶æ™‚æ˜¯å¦éœ€è¦è¼¸å…¥å§“å                           â•‘
    // â•‘    - true  = éœ€è¦è¼¸å…¥å§“å                                      â•‘
    // â•‘    - false = ä¸éœ€è¦è¼¸å…¥å§“åï¼ˆè‡ªå‹•å¡«å…¥è§’è‰²åç¨±ï¼‰                  â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const SETTINGS = {
      REQUIRE_LOGIN_FOR_CREATE: true,   // å»ºç«‹åŒ…è£¹éœ€è¦ LINE ç™»å…¥
      REQUIRE_LOGIN_FOR_SIGN: false,    // ç°½æ”¶ä¸éœ€è¦ç™»å…¥
      REQUIRE_NAME: false               // ç°½æ”¶ä¸éœ€è¦è¼¸å…¥å§“å
    };
    
    // ============ åŸºæœ¬è¨­å®š ============
    const CONFIG = {
      LIFF_ID: '2008586810-kB2lZW95',
      GAS_URL: 'https://script.google.com/macros/s/AKfycbyiUaQwXHZF6tHfYYTm3Kin2owGeEwkHCx_4_oVPF5TAJHo4SYuThI1ljVPhESar0WE/exec'
    };
    
    // ============ å…¨åŸŸè®Šæ•¸ ============
    let currentUser = {
      lineUserId: null,
      name: '',
      preferredRole: ''
    };
    
    let currentPackage = null;
    let currentSignStatus = null;
    let selectedRole = null;
    
    // ============ LIFF åˆå§‹åŒ– ============
    async function initializeLiff() {
      try {
        await liff.init({ liffId: CONFIG.LIFF_ID });
        
        // æª¢æŸ¥æ˜¯å¦å¾ QR Code é€²å…¥ï¼ˆå¸¶æœ‰ orderId åƒæ•¸ï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('orderId');
        
        // åˆ¤æ–·æ˜¯å¦éœ€è¦ç™»å…¥
        const needsLogin = orderId ? SETTINGS.REQUIRE_LOGIN_FOR_SIGN : SETTINGS.REQUIRE_LOGIN_FOR_CREATE;
        
        if (needsLogin) {
          if (!liff.isLoggedIn()) {
            liff.login();
            return;
          }
          
          // å–å¾—ä½¿ç”¨è€…è³‡è¨Š
          const profile = await liff.getProfile();
          currentUser.lineUserId = profile.userId;
          currentUser.name = profile.displayName;
          
          // å¾å¾Œç«¯å–å¾—ä½¿ç”¨è€…è¨˜éŒ„
          await loadUserInfo();
        } else {
          // å…ç™»å…¥æ¨¡å¼ï¼šç”¢ç”ŸåŒ¿å ID
          currentUser.lineUserId = 'anonymous_' + Date.now();
          currentUser.name = '';
          
          // å¦‚æœå·²ç™»å…¥ï¼Œé‚„æ˜¯å¯ä»¥å–å¾—è³‡è¨Š
          if (liff.isLoggedIn()) {
            try {
              const profile = await liff.getProfile();
              currentUser.lineUserId = profile.userId;
              currentUser.name = profile.displayName;
            } catch (e) {
              console.log('ç„¡æ³•å–å¾— LINE è³‡è¨Šï¼Œä½¿ç”¨åŒ¿åæ¨¡å¼');
            }
          }
        }
        
        if (orderId) {
          await loadPackageForSign(orderId);
        } else {
          showPage('menu');
        }
        
      } catch (error) {
        console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
        // é–‹ç™¼æ¸¬è©¦ç”¨ï¼šä¸åœ¨ LINE ç’°å¢ƒ
        currentUser.lineUserId = 'test_user_' + Date.now();
        currentUser.name = 'æ¸¬è©¦ç”¨æˆ¶';
        showPage('menu');
      }
    }
    
    // ============ é é¢æ§åˆ¶ ============
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + pageId).classList.add('active');
      
      if (pageId === 'menu') {
        // æ ¹æ“šè¨­å®šé¡¯ç¤ºæ­¡è¿è¨Šæ¯
        const welcomeEl = document.getElementById('welcome-message');
        if (currentUser.name) {
          welcomeEl.textContent = `æ­¡è¿ï¼Œ${currentUser.name}ï¼`;
        } else {
          welcomeEl.textContent = 'æ­¡è¿ä½¿ç”¨ï¼';
        }
      }
      
      if (pageId === 'sign') {
        // æ ¹æ“šè¨­å®šé¡¯ç¤º/éš±è—å§“åè¼¸å…¥æ¡†
        const nameGroup = document.getElementById('name-input-group');
        if (SETTINGS.REQUIRE_NAME) {
          nameGroup.style.display = 'block';
        } else {
          nameGroup.style.display = 'none';
        }
      }
    }
    
    // ============ API å‘¼å« ============
    async function apiGet(action, params = {}) {
	  return new Promise((resolve, reject) => {
		// å»ºç«‹å”¯ä¸€çš„ callback åç¨±ï¼ˆé¿å…è¡çªï¼‰
		const callbackName = 'jsonp_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
		
		// å»ºç«‹ URL
		const url = new URL(CONFIG.GAS_URL);
		url.searchParams.set('action', action);
		url.searchParams.set('callback', callbackName);  // é—œéµï¼šå‘Šè¨´ä¼ºæœå™¨ callback åç¨±
		
		// å°‡å…¶ä»–åƒæ•¸åŠ å…¥ URL
		Object.keys(params).forEach(key => {
		  const value = params[key];
		  if (typeof value === 'object') {
			url.searchParams.set(key, JSON.stringify(value));
		  } else {
			url.searchParams.set(key, value);
		  }
		});
		
		console.log('API Request:', url.toString());
		
		// è¨­å®šè¶…æ™‚ï¼ˆ30 ç§’ï¼‰
		const timeout = setTimeout(() => {
		  cleanup();
		  reject(new Error('è«‹æ±‚è¶…æ™‚'));
		}, 30000);
		
		// æ¸…ç†å‡½æ•¸
		const cleanup = () => {
		  clearTimeout(timeout);
		  delete window[callbackName];
		  if (script && script.parentNode) {
			script.parentNode.removeChild(script);
		  }
		};
		
		// è¨­å®šå…¨åŸŸ callback å‡½æ•¸
		window[callbackName] = (data) => {
		  console.log('API Response:', data);
		  cleanup();
		  resolve(data);
		};
		
		// å»ºç«‹ä¸¦æ’å…¥ script æ¨™ç±¤
		const script = document.createElement('script');
		script.src = url.toString();
		script.onerror = () => {
		  cleanup();
		  reject(new Error('ç¶²è·¯è«‹æ±‚å¤±æ•—'));
		};
		
		document.head.appendChild(script);
	  });
	}
    
    async function apiPost(action, data) {
	  // å°‡æ‰€æœ‰è³‡æ–™ä½œç‚ºåƒæ•¸å‚³é€
	  const params = {};
	  Object.keys(data).forEach(key => {
		const value = data[key];
		if (typeof value === 'object') {
		  params[key] = JSON.stringify(value);
		} else {
		  params[key] = value;
		}
	  });
	  
	  return await apiGet(action, params);
	}
      
      console.log('API POST URL:', url.toString());
      
      try {
        const response = await fetch(url.toString(), {
          method: 'GET',
          redirect: 'follow'
        });
        return await response.json();
      } catch (error) {
        console.error('API POST Error:', error);
        throw error;
      }
    }
    
    // ============ ä½¿ç”¨è€…è³‡è¨Š ============
    async function loadUserInfo() {
      if (!currentUser.lineUserId || currentUser.lineUserId.startsWith('anonymous_')) return;
      
      try {
        const result = await apiGet('getUserInfo', { lineUserId: currentUser.lineUserId });
        if (result.name) {
          currentUser.name = result.name;
          currentUser.preferredRole = result.preferredRole;
        }
      } catch (error) {
        console.error('è¼‰å…¥ä½¿ç”¨è€…è³‡è¨Šå¤±æ•—:', error);
      }
    }
    
    // ============ å»ºç«‹åŒ…è£¹ ============
    let itemCount = 1;
    
    function addItem() {
      const container = document.getElementById('items-container');
      const newItem = document.createElement('div');
      newItem.className = 'item-entry';
      newItem.dataset.index = itemCount;
      newItem.innerHTML = `
        <div class="item-entry-header">
          <span>å“é … ${itemCount + 1}</span>
          <button class="remove-item" onclick="removeItem(this)">Ã—</button>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 80px; gap: 8px;">
          <input type="text" class="input-field item-model" placeholder="ç”¢å“å‹è™Ÿ">
          <input type="number" class="input-field item-quantity" placeholder="æ•¸é‡" min="1" value="1">
        </div>
        <input type="text" class="input-field item-accessory" placeholder="é…ä»¶ï¼ˆé¸å¡«ï¼‰" style="margin-top: 8px;">
      `;
      container.appendChild(newItem);
      itemCount++;
    }
    
    function removeItem(btn) {
      btn.closest('.item-entry').remove();
    }
    
    // å„²å­˜æœ€å¾Œå»ºç«‹çš„åŒ…è£¹è³‡è¨Šï¼ˆç”¨æ–¼åˆ—å°å’Œ Emailï¼‰
    let lastCreatedPackage = null;

    async function createPackage() {
      // æª¢æŸ¥æ˜¯å¦éœ€è¦ç™»å…¥
      if (SETTINGS.REQUIRE_LOGIN_FOR_CREATE && !liff.isLoggedIn()) {
        liff.login();
        return;
      }
      
      const partner = document.getElementById('input-partner').value.trim();
      const receiver = document.getElementById('input-receiver').value.trim();
      
      if (!partner || !receiver) {
        alert('è«‹å¡«å¯«åˆä½œå¤¥ä¼´å’Œæ”¶ä»¶è€…');
        return;
      }
      
      // æ”¶é›†æ‰€æœ‰å“é …
      const items = [];
      document.querySelectorAll('.item-entry').forEach(entry => {
        const model = entry.querySelector('.item-model').value.trim();
        const quantity = parseInt(entry.querySelector('.item-quantity').value) || 1;
        const accessory = entry.querySelector('.item-accessory').value.trim();
        
        if (model) {
          items.push({ model, quantity, accessory });
        }
      });
      
      if (items.length === 0) {
        alert('è«‹è‡³å°‘å¡«å¯«ä¸€å€‹ç”¢å“å‹è™Ÿ');
        return;
      }
      
      showPage('loading');
      
      try {
        const result = await apiPost('createPackage', {
          partner,
          receiver,
          items,
          lineUserId: currentUser.lineUserId,
          lineName: currentUser.name
        });
        
        if (result.success) {
          // å„²å­˜å»ºç«‹çš„åŒ…è£¹è³‡è¨Š
          lastCreatedPackage = {
            orderId: result.orderId,
            partner: partner,
            receiver: receiver,
            items: items,
            qrCodeUrl: result.qrCodeUrl
          };
          
          // é¡¯ç¤ºè³‡è¨Š
          document.getElementById('created-order-id').textContent = result.orderId;
          document.getElementById('created-partner').textContent = partner;
          document.getElementById('created-receiver').textContent = receiver;
          document.getElementById('created-qr-image').src = result.qrCodeUrl;
          
          // é¡¯ç¤ºå“é …
          const itemsHtml = items.map(item => `
            <div class="item-row">
              <span>${item.model}${item.accessory ? ' (' + item.accessory + ')' : ''}</span>
              <span>Ã— ${item.quantity}</span>
            </div>
          `).join('');
          document.getElementById('created-items').innerHTML = itemsHtml;
          
          showPage('created');
          
          // æ¸…ç©ºè¡¨å–®
          document.getElementById('input-partner').value = '';
          document.getElementById('input-receiver').value = '';
          document.getElementById('items-container').innerHTML = `
            <div class="item-entry" data-index="0">
              <div style="display: grid; grid-template-columns: 1fr 80px; gap: 8px;">
                <input type="text" class="input-field item-model" placeholder="ç”¢å“å‹è™Ÿ">
                <input type="number" class="input-field item-quantity" placeholder="æ•¸é‡" min="1" value="1">
              </div>
              <input type="text" class="input-field item-accessory" placeholder="é…ä»¶ï¼ˆé¸å¡«ï¼‰" style="margin-top: 8px;">
            </div>
          `;
          itemCount = 1;
        } else {
          alert('å»ºç«‹å¤±æ•—ï¼š' + result.error);
          showPage('create');
        }
      } catch (error) {
        alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
        showPage('create');
      }
    }
    
    // åˆ—å°åŠŸèƒ½
    function printPage() {
      window.print();
    }
    
    // å¯„é€ Email åŠŸèƒ½
    async function sendEmail() {
      const emailPrefix = document.getElementById('input-email-prefix').value.trim();
      
      if (!emailPrefix) {
        alert('è«‹è¼¸å…¥ Email å¸³è™Ÿ');
        return;
      }
      
      const toEmail = emailPrefix + '@gmt.com.tw';
      
      if (!lastCreatedPackage) {
        alert('æ‰¾ä¸åˆ°åŒ…è£¹è³‡è¨Š');
        return;
      }
      
      try {
        const result = await apiPost('sendPackageEmail', {
          toEmail: toEmail,
          orderId: lastCreatedPackage.orderId,
          partner: lastCreatedPackage.partner,
          receiver: lastCreatedPackage.receiver,
          items: lastCreatedPackage.items,
          qrCodeUrl: lastCreatedPackage.qrCodeUrl
        });
        
        if (result.success) {
          alert('Email å·²å¯„å‡ºè‡³ ' + toEmail);
        } else {
          alert('å¯„é€å¤±æ•—ï¼š' + result.error);
        }
      } catch (error) {
        alert('å¯„é€éŒ¯èª¤ï¼š' + error.message);
      }
    }
    
    // ============ æƒç¢¼ ============
    async function startScan() {
      try {
        if (liff.scanCodeV2) {
          const result = await liff.scanCodeV2();
          if (result.value) {
            // è§£æ QR Code å…§å®¹
            const url = new URL(result.value);
            const orderId = url.searchParams.get('orderId');
            if (orderId) {
              await loadPackageForSign(orderId);
            } else {
              alert('ç„¡æ•ˆçš„ QR Code');
            }
          }
        } else {
          // é–‹ç™¼æ¸¬è©¦ç”¨
          const orderId = prompt('è«‹è¼¸å…¥å–®è™Ÿï¼ˆæ¸¬è©¦ç”¨ï¼‰ï¼š');
          if (orderId) {
            await loadPackageForSign(orderId);
          }
        }
      } catch (error) {
        console.error('æƒç¢¼å¤±æ•—:', error);
        // å¦‚æœæƒç¢¼å¤±æ•—ï¼Œæä¾›æ‰‹å‹•è¼¸å…¥é¸é …
        const orderId = prompt('æƒç¢¼å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¼¸å…¥å–®è™Ÿï¼š');
        if (orderId) {
          await loadPackageForSign(orderId);
        }
      }
    }
    
    // ============ æŸ¥è©¢åŒ…è£¹ ============
    async function queryPackage() {
      const orderId = document.getElementById('input-query-order').value.trim();
      if (!orderId) {
        alert('è«‹è¼¸å…¥å–®è™Ÿ');
        return;
      }
      await loadPackageForSign(orderId);
    }
    
    // ============ ç°½æ”¶æµç¨‹ ============
    async function loadPackageForSign(orderId) {
      showPage('loading');
      
      try {
        // å–å¾—åŒ…è£¹è³‡è¨Š
        const packageInfo = await apiGet('getPackageInfo', { orderId });
        if (packageInfo.error) {
          alert(packageInfo.error);
          showPage('menu');
          return;
        }
        
        // å–å¾—ç°½æ”¶ç‹€æ…‹
        const signStatus = await apiGet('getSignStatus', { orderId });
        if (signStatus.error) {
          alert(signStatus.error);
          showPage('menu');
          return;
        }
        
        currentPackage = packageInfo;
        currentSignStatus = signStatus;
        
        // æª¢æŸ¥æ˜¯å¦å·²å®Œæˆ
        if (signStatus.nextRole === 'completed') {
          showCompletedPage();
          return;
        }
        
        // é¡¯ç¤ºç°½æ”¶é é¢
        renderSignPage();
        
      } catch (error) {
        alert('è¼‰å…¥å¤±æ•—ï¼š' + error.message);
        showPage('menu');
      }
    }
    
    function renderSignPage() {
      // åŸºæœ¬è³‡è¨Š
      document.getElementById('sign-order-id').textContent = currentPackage.orderId;
      document.getElementById('sign-partner').textContent = currentPackage.partner;
      
      // å“é …åˆ—è¡¨
      const itemsHtml = currentPackage.items.map(item => `
        <div class="item-row">
          <span>${item.model}${item.accessory ? ' (' + item.accessory + ')' : ''}</span>
          <span>Ã— ${item.quantity}</span>
        </div>
      `).join('');
      document.getElementById('sign-items').innerHTML = itemsHtml;
      
      // é è¨­é¸æ“‡ä¸‹ä¸€å€‹è©²ç°½æ”¶çš„è§’è‰²
      selectedRole = currentSignStatus.nextRole;
      
      // é€²åº¦åˆ—ï¼ˆå¯é»æ“Šé¸æ“‡ï¼‰
      const progressHtml = renderProgress();
      document.getElementById('sign-progress').innerHTML = progressHtml;
      
      // å§“åè™•ç†ï¼ˆåªåœ¨éœ€è¦æ™‚é¡¯ç¤ºï¼‰
      if (SETTINGS.REQUIRE_NAME) {
        document.getElementById('input-signer-name').value = currentUser.name || '';
        if (currentUser.preferredRole) {
          document.getElementById('name-hint').textContent = `ğŸ’¡ ç³»çµ±å·²è¨˜ä½æ‚¨çš„å§“å`;
        }
      }
      
      showPage('sign');
    }
    
    function renderProgress() {
      const steps = [
        { key: 'driver', icon: 'ğŸšš', name: 'å¸æ©Ÿ', data: currentSignStatus.driver },
        { key: 'warehouse', icon: 'ğŸ­', name: 'åº«æˆ¿', data: currentSignStatus.warehouse },
        { key: 'engineer', icon: 'ğŸ‘·', name: 'å·¥ç¨‹å¸«', data: currentSignStatus.engineer }
      ];
      
      return steps.map(step => {
        const isCompleted = step.data.name !== '';
        const isAvailable = currentSignStatus.availableRoles.includes(step.key);
        const isSelected = selectedRole === step.key;
        const isDisabled = isCompleted || !isAvailable;
        
        let statusClass = '';
        let detail = 'ç­‰å¾…ä¸­';
        let clickHandler = '';
        
        if (isCompleted) {
          statusClass = 'completed disabled';
          detail = `${step.data.name} (${formatTime(step.data.time)})`;
        } else if (isSelected) {
          statusClass = 'selected';
          detail = 'â† é»æ“Šç°½æ”¶';
          clickHandler = `onclick="selectRole('${step.key}')"`;
        } else if (isAvailable) {
          statusClass = 'pending';
          detail = 'é»æ“Šé¸æ“‡';
          clickHandler = `onclick="selectRole('${step.key}')"`;
        } else {
          statusClass = 'disabled';
          detail = 'ç­‰å¾…ä¸­';
        }
        
        return `
          <div class="progress-step ${statusClass}" data-role="${step.key}" ${clickHandler}>
            <div class="step-icon ${isCompleted ? 'completed' : (isSelected ? 'current' : 'pending')}">${isCompleted ? 'âœ“' : step.icon}</div>
            <div class="step-info">
              <div class="step-title">${step.name}</div>
              <div class="step-detail">${detail}</div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function selectRole(role) {
      selectedRole = role;
      // é‡æ–°æ¸²æŸ“é€²åº¦åˆ—
      const progressHtml = renderProgress();
      document.getElementById('sign-progress').innerHTML = progressHtml;
    }
    
    async function confirmSign() {
      // æ ¹æ“šè¨­å®šæ±ºå®šå§“å
      let name = '';
      const roleNames = { driver: 'å¸æ©Ÿ', warehouse: 'åº«æˆ¿', engineer: 'å·¥ç¨‹å¸«' };
      
      if (SETTINGS.REQUIRE_NAME) {
        name = document.getElementById('input-signer-name').value.trim();
        if (!name) {
          alert('è«‹è¼¸å…¥æ‚¨çš„å§“å');
          return;
        }
      } else {
        // ä¸éœ€è¦å§“åæ™‚ï¼Œä½¿ç”¨è§’è‰²åç¨±
        name = roleNames[selectedRole];
      }
      
      if (!selectedRole) {
        alert('è«‹é¸æ“‡æ‚¨çš„èº«ä»½');
        return;
      }
      
      document.getElementById('btn-confirm-sign').disabled = true;
      
      try {
        const result = await apiPost('signPackage', {
          orderId: currentPackage.orderId,
          role: selectedRole,
          name: name,
          lineUserId: currentUser.lineUserId
        });
        
        if (result.success) {
          // æ›´æ–°ä½¿ç”¨è€…å§“åï¼ˆåƒ…åœ¨éœ€è¦æ™‚ï¼‰
          if (SETTINGS.REQUIRE_NAME) {
            currentUser.name = name;
          }
          
          // é¡¯ç¤ºæˆåŠŸé é¢
          document.getElementById('sign-complete-title').textContent = 
            `${roleNames[selectedRole]}ç°½æ”¶æˆåŠŸï¼`;
          
          // é¡¯ç¤ºè©³æƒ…
          let detailsHtml = `
            <div class="info-row">
              <span class="info-label">å–®è™Ÿ</span>
              <span class="info-value">${currentPackage.orderId}</span>
            </div>
          `;
          
          // å¦‚æœæœ‰è¼¸å…¥å§“åæ‰é¡¯ç¤º
          if (SETTINGS.REQUIRE_NAME) {
            detailsHtml += `
              <div class="info-row">
                <span class="info-label">ç°½æ”¶è€…</span>
                <span class="info-value">${name}</span>
              </div>
            `;
          }
          
          // åˆ¤æ–·ä¸‹ä¸€ç«™
          const nextRole = result.status.nextRole;
          
          if (nextRole === 'completed') {
            detailsHtml += `
              <div style="text-align: center; margin-top: 20px; color: #28a745;">
                <div style="font-size: 32px;">ğŸ‰</div>
                <div>ç‰©æµè¿½è¹¤å·²å®Œæˆï¼</div>
              </div>
            `;
          } else {
            const nextRoleNames = { driver: 'å¸æ©Ÿ', warehouse: 'åº«æˆ¿', engineer: 'å·¥ç¨‹å¸«' };
            detailsHtml += `
              <div style="text-align: center; margin-top: 20px; color: #667eea;">
                <div>ğŸ“ ä¸‹ä¸€ç«™ï¼š${nextRoleNames[nextRole]}</div>
              </div>
            `;
          }
          
          document.getElementById('sign-complete-details').innerHTML = detailsHtml;
          showPage('sign-complete');
          
        } else {
          alert('ç°½æ”¶å¤±æ•—ï¼š' + result.error);
        }
        
      } catch (error) {
        alert('ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
      }
      
      document.getElementById('btn-confirm-sign').disabled = false;
    }
    
    function showCompletedPage() {
      let detailsHtml = `
        <div class="info-row">
          <span class="info-label">å–®è™Ÿ</span>
          <span class="info-value">${currentPackage.orderId}</span>
        </div>
        <div class="info-row">
          <span class="info-label">å» å®¶</span>
          <span class="info-value">${currentPackage.partner}</span>
        </div>
        <hr style="margin: 16px 0; border: none; border-top: 1px solid #eee;">
        <div class="card-title">ğŸ“ ç°½æ”¶æ­·ç¨‹</div>
        <div class="progress-step completed">
          <div class="step-icon completed">âœ“</div>
          <div class="step-info">
            <div class="step-title">ğŸšš å¸æ©Ÿ</div>
            <div class="step-detail">${currentSignStatus.driver.name} (${formatTime(currentSignStatus.driver.time)})</div>
          </div>
        </div>
        <div class="progress-step completed">
          <div class="step-icon completed">âœ“</div>
          <div class="step-info">
            <div class="step-title">ğŸ­ åº«æˆ¿</div>
            <div class="step-detail">${currentSignStatus.warehouse.name} (${formatTime(currentSignStatus.warehouse.time)})</div>
          </div>
        </div>
        <div class="progress-step completed">
          <div class="step-icon completed">âœ“</div>
          <div class="step-info">
            <div class="step-title">ğŸ‘· å·¥ç¨‹å¸«</div>
            <div class="step-detail">${currentSignStatus.engineer.name} (${formatTime(currentSignStatus.engineer.time)})</div>
          </div>
        </div>
      `;
      
      document.getElementById('completed-details').innerHTML = detailsHtml;
      showPage('completed');
    }
    
    // ============ å·¥å…·å‡½æ•¸ ============
    function formatTime(dateStr) {
      if (!dateStr) return '-';
      try {
        const date = new Date(dateStr);
        return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
      } catch (e) {
        return '-';
      }
    }
    
    // ============ å•Ÿå‹• ============
    document.addEventListener('DOMContentLoaded', initializeLiff);
  </script>
</body>
</html>